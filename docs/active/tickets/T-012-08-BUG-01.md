---
id: T-012-08-BUG-01
story: S-012
title: hillside-loop-not-traversable
type: bug
status: open
priority: high
phase: done
depends_on: []
---

## Summary

The hillside stage loop is not traversable. A spindash from x=3100 enters the
loop ramp and reaches Q1 (right-wall angles 33-96), but the player gets trapped
oscillating between tiles around x=3445-3449. The player never reaches Q2
(ceiling angles 97-160) and never exits the loop region.

## Reproduction

```python
from speednik.simulation import create_sim, sim_step
from speednik.terrain import get_quadrant
from speednik.physics import InputState
from speednik.player import PlayerState

sim = create_sim("hillside")
sim.player.physics.x = 3100.0
sim.player.physics.y = 610.0
# Spindash then hold right for 600 frames
# -> grounded_quadrants == {0, 1}, expected {0, 1, 2, 3}
```

## Diagnostic Evidence

From `tests/test_loop_audit.py::TestHillsideLoopTraversal`:

```
Trajectory through loop region (x=3472..3744):
  f= 32: x=   3409 y=   608 gs= 10.3 og=True  q=0  state=rolling  ← approach
  f= 35: x=   3432 y=   592 gs= 10.1 og=True  q=1  state=rolling  ← entered Q1
  f= 37: x=   3443 y=   575 gs=  9.9 og=True  q=1  state=rolling
  f= 38: x=   3447 y=   582 gs=  9.8 og=True  q=1  state=rolling  ← oscillation
  f= 39: x=   3445 y=   573 gs=  9.7 og=True  q=1  state=rolling
  f= 40: x=   3448 y=   580 gs=  9.6 og=True  q=1  state=rolling
  ...  (292 total frames in loop region, all stuck in Q1)

Player never reached Q2 (ceiling). Stuck on lower quadrants.
```

The player position oscillates between y=571-589 at x=3443-3449, decelerating
from gs=10.3 to near zero. The sensor system keeps the player on_ground but
the angle never advances past Q1 into Q2.

## Analysis

The hillside loop uses hand-placed tiles from `tile_map.json`. Unlike the
synthetic `build_loop()` which uses angular sampling to produce smooth angle
progressions, the hillside tiles likely have:

1. **Non-smooth angle transitions**: Adjacent tiles may have angle jumps >20
   byte-angle units, causing the two-pass sensor mechanism to fail
2. **Incorrect height arrays**: Tile height profiles may not accurately
   represent the loop curvature, causing the player to snap to incorrect
   surface positions
3. **Missing wall quadrant tiles**: The loop may lack tiles with angles in
   the Q2 range (97-160), preventing the sensor system from ever detecting
   a ceiling surface

The synthetic `build_loop()` loops work for radii 32-96, confirming the
physics engine CAN traverse loops. The issue is specific to the hillside
stage geometry.

## Impact

The hillside loop is purely decorative — the player always flies over it
rather than running through it. This is the core visual difference from
Sonic 2 where loops are a signature gameplay mechanic.

## Acceptance Criteria

- [ ] Player spindashing from x=3100 visits grounded quadrants {0, 1, 2, 3}
- [ ] Player exits the loop region (x > 3744) with positive ground_speed
