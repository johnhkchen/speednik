---
id: T-010-02
story: S-010
title: sim-step-and-event-system
type: task
status: open
priority: high
phase: implement
depends_on: [T-010-01]
---

## Context

Implement `sim_step()` — the single function that advances the headless simulation by one
frame. This is the core of Layer 2. It mirrors `main.py:_update_gameplay()` without any
rendering or audio calls.

See `docs/specs/scenario-testing-system.md` §2.3 for the reference implementation.

### sim_step function

```python
def sim_step(sim: SimState, inp: InputState) -> list[Event]:
    """Advance one frame. Returns events that occurred."""
```

The function must execute the same sequence as `_update_gameplay()`:

1. Check if player is dead → return `DeathEvent`, set `player_dead`
2. Call `player_update(player, inp, tile_lookup)`
3. Increment frame counter
4. Check ring collection → `RingCollectedEvent`s
5. Check spring collision → `SpringEvent`s
6. Check checkpoint collision → `CheckpointEvent`s
7. Update pipe travel
8. Update liquid zones
9. Update enemies
10. Check enemy collision → `DamageEvent`s or `DeathEvent`s
11. Update spring cooldowns
12. Check goal collision → `GoalReachedEvent`
13. Update metrics (max_x, rings_collected)

**Order matters.** The sequence must match `main.py` exactly or physics/collision outcomes
will diverge. When in doubt, read `_update_gameplay()` line by line.

### Death and respawn handling

In the headless simulation, death increments `sim.deaths` and sets `sim.player_dead = True`.
The simulation does NOT auto-respawn — the caller decides what to do (the scenario runner
may end the episode, the gym env may reset, etc.). This is a deliberate difference from
`main.py` which has its own death timer and respawn logic.

### Enemy update

`update_enemies(enemies)` and `check_enemy_collision(player, enemies)` already exist in
`enemies.py` and are Pyxel-free. Call them directly. The boss (enemy_egg_piston) needs the
frame-based state machine updates — verify these work without the boss arena music trigger.

### Location

`speednik/simulation.py` — extend the file from T-010-01.

## Acceptance Criteria

- [ ] `sim_step` advances player physics by one frame
- [ ] `sim_step` processes ring collection and returns `RingCollectedEvent`s
- [ ] `sim_step` processes spring collision and returns `SpringEvent`s
- [ ] `sim_step` processes checkpoint collision
- [ ] `sim_step` processes enemy collision (damage and kills)
- [ ] `sim_step` detects goal reached and sets `sim.goal_reached`
- [ ] `sim_step` detects player death and sets `sim.player_dead`
- [ ] `sim_step` updates `sim.max_x_reached` and `sim.rings_collected`
- [ ] Event processing order matches `main.py:_update_gameplay()`
- [ ] Enemies update each frame (including boss state machine)
- [ ] No Pyxel imports
- [ ] Basic smoke test: 60 frames of `hold_right` on hillside, player x increases
- [ ] `uv run pytest tests/ -x` passes
