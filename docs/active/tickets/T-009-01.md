---
id: T-009-01
story: S-009
title: debug-flag-and-hud-overlay
type: task
status: open
priority: medium
phase: done
depends_on: []
---

## Context

Add a `SPEEDNIK_DEBUG` environment variable that gates developer features. When set, it
enables a debug HUD overlay during gameplay and unlocks the dev park stages in the stage
select menu. When unset, the game behaves identically to today — zero player-facing impact.

### DEBUG flag

```python
# speednik/debug.py
import os

DEBUG = os.environ.get("SPEEDNIK_DEBUG", "") == "1"
```

Single source of truth. Everything else imports `from speednik.debug import DEBUG`.

### Debug HUD overlay

When `DEBUG` is True, render a translucent overlay in the top-right corner during gameplay
showing real-time physics state:

```
F:1234  X:3456.2  Y:512.0
GS:6.00  A:32  Q:0
STATE:running  GND:Y
```

Fields:
- **F** — Frame counter (incremented each gameplay update)
- **X, Y** — Player world position (1 decimal)
- **GS** — Ground speed (2 decimals)
- **A** — Angle (byte 0-255)
- **Q** — Quadrant (0-3)
- **STATE** — PlayerState value
- **GND** — on_ground (Y/N)

Use Pyxel's built-in `pyxel.text()` for rendering. Draw after the HUD reset (`pyxel.camera()`)
so it's in screen space. Position in the top-right corner to avoid overlapping the
lives/rings/time HUD in the top-left.

### Stage select gate

When `DEBUG` is True, add a "DEV PARK" entry to the stage select menu. This entry is always
unlocked (not gated by `unlocked_stages`). It appears as stage 0 or after the last real
stage — whichever is cleaner given the UP/DOWN navigation.

The stage select rendering already handles variable stage counts via `_NUM_STAGES`. Adjusting
the range and adding a conditional entry when DEBUG is the minimal change.

### Debug respawn

Two behaviors when `DEBUG` is True:

**Instant respawn on death** — Skip the `DEATH_DELAY_FRAMES` (120 frame / 2 second) death
animation. When the player enters `PlayerState.DEAD` and DEBUG is on, respawn immediately
(next frame). The normal death sequence (knockback arc, timer, life decrement) still happens
in non-debug mode. In debug mode: detect DEAD state, reset player to `respawn_x/respawn_y`
(or `player_start` if no checkpoint), skip the timer entirely. Lives still decrement so the
developer sees the count, but game-over is suppressed — lives reset to 3 silently instead of
going to the game over screen.

**Manual respawn hotkey** — Press `R` during gameplay to instantly teleport the player back
to the stage's `player_start` position. Full state reset: velocity zeroed, on_ground=True,
state=STANDING, angle=0. No life cost. This is for when you've wandered off an edge or
gotten stuck and just want to start over without restarting the stage.

```python
# In _update_gameplay, after reading input:
if DEBUG and pyxel.btnp(pyxel.KEY_R):
    px, py = self.stage.player_start
    self.player.physics.x = float(px)
    self.player.physics.y = float(py)
    self.player.physics.x_vel = 0.0
    self.player.physics.y_vel = 0.0
    self.player.physics.ground_speed = 0.0
    self.player.physics.angle = 0
    self.player.physics.on_ground = True
    self.player.state = PlayerState.STANDING
    self.camera.reset(float(px), float(py))
```

**Test harness note** — The headless `ScenarioResult` (S-008) should track whether the
player died during the run. Add a `deaths: int` counter and `death_frames: list[int]` to
`ScenarioResult` so tests can assert on death events. For boundary escape tests (T-009-05),
a death is actually *better* than escaping — it means the game caught the problem. The test
should distinguish "player died at the edge" (acceptable) from "player sailed past the edge
alive" (the real bug).

### Location

- `speednik/debug.py` — new file, just the flag
- `speednik/main.py` — import flag, conditionally render HUD, conditionally show dev park
  in stage select
- `speednik/renderer.py` — add `draw_debug_hud(player, frame)` function

## Acceptance Criteria

- [ ] `SPEEDNIK_DEBUG=1` enables debug features; unset or `0` disables them
- [ ] Debug HUD renders during gameplay showing F, X, Y, GS, A, Q, STATE, GND
- [ ] Debug HUD does not overlap the existing lives/rings/time HUD
- [ ] Debug HUD only appears when DEBUG is True
- [ ] Stage select shows "DEV PARK" entry when DEBUG is True
- [ ] Stage select hides "DEV PARK" when DEBUG is False
- [ ] "DEV PARK" is always selectable (not gated by unlocked_stages)
- [ ] Selecting "DEV PARK" transitions to a dev park state (placeholder for now — can show
  "DEV PARK" text on a blank screen until T-009-03 implements the actual stages)
- [ ] `R` key during gameplay respawns player to `player_start` with full state reset
- [ ] `R` key only works when DEBUG is True
- [ ] `R` key resets velocity, angle, state, and camera
- [ ] Instant respawn on death in debug mode — no 2-second death animation delay
- [ ] Lives still decrement on death in debug mode (developer sees the count)
- [ ] Game over suppressed in debug mode — lives silently reset to 3 instead
- [ ] No behavior changes when SPEEDNIK_DEBUG is unset
- [ ] `uv run pytest tests/ -x` passes
