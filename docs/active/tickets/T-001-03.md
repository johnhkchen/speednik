---
id: T-001-03
story: S-001
title: tile-collision-system
type: task
status: open
priority: critical
phase: done
depends_on: [T-001-02]
---

## Context

Implement the tile-based collision system with height arrays, angle storage, and the full sensor suite. This is the most failure-prone component — most Sonic engine attempts break here.

Reference: docs/specification.md section 3

## Acceptance Criteria

- [ ] `terrain.py` implements:
  - Tile data structure: 16x16 block with height_array (16 values, 0–16), angle (0–255), solidity flag (not_solid / top_only / full / lrb_only)
  - Top-only tile behavior: ignore when y_vel < 0, collide only when y_vel >= 0 and approaching from above
  - Height array lookup: given a sensor X position within a tile, return the solid height at that column
  - Width array: height array rotated 90° for wall detection
- [ ] Sensor system in `terrain.py` or `player.py`:
  - A/B floor sensors: cast downward, extension (check below on height=0), regression (check above on height=16), use shorter distance, **A wins ties**
  - C/D ceiling sensors: mirror of A/B casting upward
  - E/F wall sensors: cast horizontal, use width array, disabled when moving away from wall
  - Sensor positions respect current state: standing (width_radius=9, height_radius=20) vs rolling (width_radius=7, height_radius=14)
  - Sensor range: current tile + one adjacent (32px max), reject distances > 32px
- [ ] Angle quadrant mode switching: sensors rotate based on player angle (0–45/316–360 = normal, 46–134 = right wall, 135–225 = ceiling, 226–315 = left wall)
- [ ] Tile-boundary crossing: both A and B checked independently each frame, winning sensor switches naturally at tile boundaries
- [ ] Landing: snap player angle to landed tile's angle immediately, do not carry air angle
- [ ] Unit tests for: flat ground collision, 45° slope adherence, top-only platform pass-through from below, tile boundary crossing, loop traversal (angle quadrant switching)
