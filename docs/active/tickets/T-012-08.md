---
id: T-012-08
story: S-012
title: loop-traversal-audit
type: bug
status: open
priority: critical
phase: done
depends_on: [T-012-01]
---

## Context

Loop-de-loops are not traversable. The existing T-011-03 geometry probe claimed loops
"pass" by testing that the player **jumps over** the loop rather than **runs through** it.
The probe docstring explicitly says: "the player enters the loop ramp and hits quadrant 1
before launching airborne over the loop." The assertions were written against this broken
behavior:

- `test_enters_loop_quadrant`: asserts `1 in visited` — only one quadrant, not all four
- `test_crosses_loop_region`: asserts `max_x > 3744` — player clears the X range aerially
- No assertion that the player was ever on_ground inside the loop body

Evidence from hillside: a spindash from x=3100 visits quadrants {0, 1} only. The player
hits the entry ramp, gets launched airborne, arcs over the top, and lands past the exit.
This is not loop traversal — it's a failed ramp launch.

**A working loop means the player stays on the loop surface and visits all 4 quadrants
{0, 1, 2, 3} while on_ground.** That is what Sonic 2 loops do, and that is what this
ticket tests for.

### Your role

You are a QA auditor. Write tests that describe what loop traversal SHOULD look like. When
the game doesn't deliver it, that's a finding — not a test to weaken. Do NOT write tests
that describe the current broken behavior as correct.

### Phase 1: Synthetic grid loop (isolation test)

Use `build_loop()` from `speednik/grids.py` to test loop mechanics in total isolation —
no stage geometry, no entities, no distractions. This is the composable building block test.

```python
def test_loop_full_traversal_synthetic():
    """Spindash through a synthetic loop. All 4 quadrants visited on_ground."""
    tiles, lookup = build_loop(
        approach_tiles=15, radius=48, ground_row=20, ramp_radius=32
    )
    sim = create_sim_from_lookup(lookup, start_x=48.0, start_y=304.0)
    # Spindash strategy...
    # Assert:
    #   quadrants_on_ground == {0, 1, 2, 3}
    #   player exits with positive ground_speed
    #   player is on_ground after exit
```

**Parameterize across loop radii:** test radius 32, 48, 64, 96. All should be traversable
at spindash speed. Document which radii work and which don't.

**Parameterize across entry speeds:** What's the minimum speed to complete the loop? Test
speeds from 4.0 to 12.0 in steps of 1.0. A radius-48 loop should be completable at
spindash base speed (8.0). Document the actual minimum.

The key assertion for every test:

```python
# Collect quadrants where player was ON GROUND (not airborne)
grounded_quadrants = {s.quadrant for s in snaps if s.on_ground}
assert grounded_quadrants == {0, 1, 2, 3}, (
    f"Loop not fully traversed on ground. "
    f"Grounded quadrants: {grounded_quadrants}, "
    f"All quadrants visited: {all_quadrants}"
)
```

This is the critical distinction from the T-011-03 probe. Visiting quadrants while airborne
doesn't count — the player must be following the loop surface.

### Phase 2: Real stage loop (hillside)

Once the synthetic test documents the findings, run the same assertions against the actual
hillside loop:

```python
def test_loop_full_traversal_hillside():
    """Spindash through the hillside loop. All 4 quadrants visited on_ground."""
    sim = create_sim("hillside")
    sim.player.physics.x = 3100.0
    sim.player.physics.y = 610.0
    # Spindash...
    grounded_quadrants = {s.quadrant for s in snaps if s.on_ground}
    assert grounded_quadrants == {0, 1, 2, 3}
```

### Phase 3: Diagnostic output

When a loop test fails, the assertion message should include diagnostic data that helps
identify the root cause:

```
LOOP AUDIT FAILED (radius=48, entry_speed=8.0):
  Grounded quadrants: {0, 1}  (expected {0, 1, 2, 3})
  All quadrants (incl. airborne): {0, 1}

  Trajectory through loop region (x=3472..3744):
    f=102: x=3465 y=610 gs=7.8 og=True  q=0  state=rolling    ← approaching
    f=103: x=3473 y=608 gs=7.5 og=True  q=1  state=rolling    ← entered ramp
    f=104: x=3480 y=603 gs=6.2 og=False q=0  state=jumping    ← LOST GROUND
    f=105: x=3486 y=597 gs=0.0 og=False q=0  state=jumping    ← airborne
    ...
    f=118: x=3530 y=582 gs=0.0 og=False q=0  state=jumping    ← still airborne
    f=130: x=3570 y=610 gs=0.0 og=True  q=0  state=standing   ← landed past loop

  Player lost ground contact at frame 104, x=3480 (loop entry ramp).
  Entry ramp tile angle=47 (66°) — may be too steep for ground adhesion at gs=6.2.

  Probable causes:
    - Entry ramp angle too steep (player pops off surface)
    - Ground speed too low to maintain centripetal adhesion
    - Quadrant switching logic fails at ramp→loop transition
```

This diagnostic output is part of the test — it's what the agent reads to understand WHY
the loop failed and file an informed bug ticket.

### Expected findings

Based on current behavior, expect:
- Synthetic loops likely fail at all radii (physics/collision issue, not stage data)
- Hillside loop fails (quadrants {0, 1} only, player goes airborne at ramp entry)
- Root cause is likely one or more of:
  - Entry ramp too steep, player loses ground contact
  - Quadrant switching not triggering at the ramp→loop angle transition
  - Loop tile SURFACE_LOOP type not properly handled in collision resolution
  - Centripetal force / speed-dependent adhesion not implemented

### Bug ticket workflow

When tests fail (they will), create a bug ticket per root cause:
- `T-012-08-BUG-01`: description of the specific physics failure
- xfail the test with the bug ticket reference
- The bug ticket contains the diagnostic output and probable cause

### Location

`tests/test_loop_audit.py` — new file.
Bug tickets in `docs/active/tickets/T-012-08-BUG-*.md`

## Acceptance Criteria

- [ ] Synthetic loop test asserts all 4 grounded quadrants (not just "crosses the region")
- [ ] Parameterized across radii: 32, 48, 64, 96
- [ ] Parameterized across entry speeds: 4.0 to 12.0
- [ ] Real stage test for hillside loop with same grounded-quadrant assertion
- [ ] Diagnostic output includes per-frame trajectory through loop region
- [ ] Diagnostic output identifies frame where ground contact was lost
- [ ] Diagnostic output suggests probable cause
- [ ] Failing tests xfailed with bug ticket references (not weakened)
- [ ] Bug tickets filed with diagnostic evidence and probable cause
- [ ] No assertions written against current broken behavior
- [ ] `uv run pytest tests/test_loop_audit.py -v` runs clean (xfails expected)
