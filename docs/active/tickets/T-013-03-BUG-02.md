---
id: T-013-03-BUG-02
story: S-013
title: audit-no-respawn-after-pit-death
type: bug
status: open
priority: high
phase: done
depends_on: []
---

## Finding

The `run_audit()` function in `speednik/qa.py` does not respawn the player after pit
death. When a player dies from falling below level_height + PIT_DEATH_MARGIN, the
simulation continues running for thousands of frames with a dead player. The dead player
never moves, so no further x-progress is possible.

This suppresses the true x-progress potential of archetypes that would otherwise recover
from a single death. Speed Demon dies at frame 217 (max_x=690) but would likely reach
much further with checkpoint respawn. Jumper dies at frame 1346 (max_x=2415) with
similar suppression.

## Evidence

- Speed Demon: dies frame 217, simulation continues to frame 6000 (5783 wasted frames)
- Jumper: dies frame 1346, simulation continues to frame 6000 (4654 wasted frames)
- Chaos: dies frame ~200, same pattern
- `SimState.player_dead` is never set to True â€” the `run_audit` break condition
  `sim.player_dead` never triggers

## Root Cause

Two contributing factors:

1. **No respawn logic**: `run_audit()` calls `sim_step()` in a loop but has no respawn
   mechanism. When `sim.player.state == DEAD`, the loop should either respawn the player
   at the last checkpoint or terminate early.

2. **player_dead never set**: `SimState.player_dead` field (simulation.py:119) is never
   set by any code path. The pit death logic sets `player.state = DEAD` but not
   `sim.player_dead`. The `run_audit` break condition checks both `goal_reached` and
   `player_dead`, but only `goal_reached` can ever become True.

## Expected

After pit death, the player should respawn at the last activated checkpoint (or stage
start if no checkpoint activated). The audit should measure cumulative x-progress across
respawns, limited by max_deaths.

## Reproduction

```python
from speednik.qa import run_audit, BehaviorExpectation, make_speed_demon
exp = BehaviorExpectation(
    name="test", stage="skybridge", archetype="speed_demon",
    min_x_progress=5000, max_deaths=1, require_goal=True,
    max_frames=6000, invariant_errors_ok=0,
)
findings, result = run_audit("skybridge", make_speed_demon(), exp)
# result.sim.deaths=1, but 5783 frames wasted after death
```
