---
id: T-009-04
story: S-009
title: security-camera-quad-split
type: task
status: open
priority: medium
phase: done
depends_on: [T-009-02]
---

## Context

Build the security-camera quad-split view: four bot strategies running simultaneously on the
same terrain, each in its own viewport quadrant. This is the marquee dev park feature — at a
glance, the developer sees how idle, hold_right, hold_right_jump, and spindash_right all
behave on the same stage.

### Layout

The 256×224 screen splits into four 128×112 quadrants:

```
┌──────────────┬──────────────┐
│ (0,0)        │ (128,0)      │
│   IDLE       │  HOLD_RIGHT  │
│   128×112    │  128×112     │
├──────────────┼──────────────┤
│ (0,112)      │ (128,112)    │
│   JUMP       │  SPINDASH    │
│   128×112    │  128×112     │
└──────────────┴──────────────┘
```

Each quadrant:
- Has its own `LiveBot` with an independent camera
- Renders terrain + player clipped to its rectangle
- Shows a strategy label in the corner (e.g., "IDLE" in 3×5 pixel font)
- Shows a mini status line: X position and state

### Rendering with pyxel.clip()

Pyxel supports `pyxel.clip(x, y, w, h)` to restrict drawing to a rectangle. The quad-split
renderer:

```python
QUADRANTS = [
    (0,   0,   128, 112),  # top-left
    (128, 0,   128, 112),  # top-right
    (0,   112, 128, 112),  # bottom-left
    (128, 112, 128, 112),  # bottom-right
]

def draw_quad_split(bots: list[LiveBot]):
    for (qx, qy, qw, qh), bot in zip(QUADRANTS, bots):
        pyxel.clip(qx, qy, qw, qh)

        # Offset camera so bot's world renders into this quadrant
        cam_x = bot.camera.x - qx
        cam_y = bot.camera.y - qy
        pyxel.camera(cam_x, cam_y)

        draw_terrain(bot.tile_lookup, bot.camera.x, bot.camera.y)
        draw_player(bot.player)

        # Label in screen space
        pyxel.camera()
        pyxel.text(qx + 2, qy + 2, bot.label, 7)
        pyxel.text(qx + 2, qy + qh - 8,
                   f"X:{bot.player.physics.x:.0f}", 7)

    pyxel.clip()  # reset clip
```

The camera math needs care: `pyxel.camera(cx, cy)` offsets all subsequent draws by
`(-cx, -cy)`. To render world coordinates into a quadrant at screen position `(qx, qy)`,
the camera offset must account for both the world camera position and the quadrant offset.

### Divider lines

Draw 1px lines at x=128 (vertical) and y=112 (horizontal) after rendering all quadrants,
in a bright color (white or green) to visually separate the panes.

### Applicable terrain

The quad-split can run against:
- **Synthetic grids** — e.g., the ramp walker or loop lab grid, 4 strategies compared
- **Real stages** — e.g., hillside, 4 strategies starting from player_start

Add a quad-split option to each dev park stage (toggle with a key, e.g., TAB switches
between single-bot and quad-split view). Or make the quad-split its own dev park stage entry:
"MULTI-VIEW: HILLSIDE", "MULTI-VIEW: RAMP".

### Camera scaling consideration

Each quadrant is 128×112 — half the normal 256×224 viewport. The camera from `camera.py`
assumes the full screen size for its border calculations. Options:

1. **Create a `MiniCamera`** with halved border values (simplest)
2. **Parameterize `Camera`** to accept viewport dimensions
3. **Just use the normal camera** and accept that the visible area is smaller (the bot may
   go off-screen briefly before the camera catches up — probably fine for a debug view)

Option 3 is simplest to ship. Option 2 is cleanest long-term. Choose based on how jarring
the camera lag looks in practice.

### Location

- `speednik/devpark.py` — quad-split render function, integrated into dev park stage loop

## Acceptance Criteria

- [ ] Quad-split renders 4 bot viewports at 128×112 each
- [ ] Each quadrant shows its own bot with independent camera and terrain
- [ ] Strategy labels visible in each quadrant corner
- [ ] Position readout visible in each quadrant
- [ ] Divider lines separate the four quadrants
- [ ] `pyxel.clip()` prevents cross-quadrant bleed
- [ ] All 4 bots update independently each frame
- [ ] Quad-split works with both synthetic grids and real stage data
- [ ] Camera follows each bot within its quadrant
- [ ] X key exits back to dev park menu
- [ ] Performance acceptable at 60fps with 4 simultaneous bots (profile if needed —
  terrain rendering is the likely bottleneck; 4× draw calls in half viewports should be
  roughly 2× total work)
- [ ] `uv run pytest tests/ -x` passes
