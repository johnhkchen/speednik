---
id: T-010-03
story: S-010
title: simulation-parity-tests
type: task
status: open
priority: high
phase: done
depends_on: [T-010-02]
---

## Context

Write tests that verify the headless simulation produces identical results to the existing
`tests/harness.py` for the player+terrain subset, and then verify the full simulation
(with objects and enemies) behaves correctly.

This is the "did we extract the game loop correctly?" gate. If the simulation diverges from
the harness on pure player+terrain scenarios, something is wrong with `sim_step`'s ordering
or state management.

### Parity tests (simulation vs harness)

Run identical scenarios through both systems and compare trajectories:

```python
def test_sim_matches_harness_hold_right_flat():
    """sim_step with hold_right on flat ground matches harness.run_scenario."""
    # Run through harness
    harness_result = run_scenario(build_flat(40, 20), 48.0, y, hold_right, 300)
    # Run through simulation with same tile_lookup
    sim = create_sim_from_lookup(build_flat(40, 20), 48.0, y)
    for frame in range(300):
        inp = hold_right(frame, sim.player)
        sim_step(sim, inp)
    # Compare final positions
    assert sim.player.physics.x == pytest.approx(harness_result.final.x, abs=0.01)
    assert sim.player.physics.y == pytest.approx(harness_result.final.y, abs=0.01)
```

Run this for multiple strategies (idle, hold_right, spindash) on flat and ramped terrain.
The positions must match exactly (or within float epsilon) since both call the same
`player_update` function.

### A helper `create_sim_from_lookup` may be needed

The harness uses raw `TileLookup` callables. The simulation uses `create_sim(stage_name)`.
Add a `create_sim_from_lookup(tile_lookup, start_x, start_y)` factory that creates a
`SimState` with empty entity lists — used for parity tests against synthetic grids where
no rings/enemies exist.

### Full simulation tests

Verify object interactions work:

- Run `hold_right` on hillside. Assert `rings_collected > 0` (player picks up rings).
- Run `hold_right` on hillside. Assert `SpringEvent` occurs if the path has a spring.
- Run `hold_right` on pipeworks. Assert the player encounters gaps (y increases past
  level_height or deaths > 0).
- Verify goal detection: position player near goal, step forward, assert `goal_reached`.

### Performance benchmark

Time 1000 frames of `sim_step` on hillside. The spec estimates 20,000-50,000 updates/sec
with full entity processing. Log the actual number as a reference point for the gym wrapper
and RL training.

### Location

`tests/test_simulation.py` — new file.

## Acceptance Criteria

- [ ] Parity test: hold_right on flat grid, simulation matches harness within float epsilon
- [ ] Parity test: idle on flat grid, simulation matches harness
- [ ] Parity test: spindash_right on flat grid, simulation matches harness
- [ ] `create_sim_from_lookup` factory for synthetic grid scenarios
- [ ] Full sim test: ring collection on hillside produces RingCollectedEvents
- [ ] Full sim test: goal detection works when player reaches goal position
- [ ] Full sim test: enemy collision produces DamageEvent or DeathEvent
- [ ] Performance benchmark logged (updates/sec for 1000 frames on hillside)
- [ ] No Pyxel imports
- [ ] `uv run pytest tests/test_simulation.py -x` passes
