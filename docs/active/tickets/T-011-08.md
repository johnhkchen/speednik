---
id: T-011-08
story: S-011
title: extract-shared-code-from-tests
type: bug
status: open
priority: critical
phase: done
depends_on: [T-010-02]
---

## Context

`speednik/devpark.py` imports from `tests.grids` and `tests.harness` at 10 call sites.
This works under pytest (which adds the project root to `sys.path`) but crashes when
running the game normally or in the web build:

```
ModuleNotFoundError: No module named 'tests'
```

The root cause: grid builders and strategy functions are shared code used by both the game
(`devpark.py`) and the test suite, but they live in `tests/` — which is not a Python
package on the runtime path.

### Fix

Move the shared code into `speednik/`:

1. **`tests/grids.py`** → **`speednik/grids.py`**
   - All public builders: `build_flat`, `build_gap`, `build_slope`, `build_ramp`, `build_loop`
   - Internal helpers: `_wrap`, `_flat_tile`, `_fill_below`, `_slope_height_array`
   - No changes to function signatures or behavior.

2. **Strategy functions from `tests/harness.py`** → **`speednik/strategies.py`**
   - `idle`, `hold_right`, `hold_left`, `hold_right_jump`, `spindash_right`, `scripted`
   - The `Strategy` type alias, `FrameSnapshot`, `ScenarioResult` dataclasses
   - `run_scenario`, `run_on_stage` runner functions

3. **Update imports in `speednik/devpark.py`**:
   - `from tests.grids import build_ramp` → `from speednik.grids import build_ramp`
   - `from tests.harness import hold_right` → `from speednik.strategies import hold_right`

4. **Update `tests/grids.py` and `tests/harness.py`**:
   - Either delete and update all test imports to point at `speednik/`, or
   - Convert to thin re-export shims: `from speednik.grids import *`
   - Prefer the re-export approach to minimize churn in existing test files.

5. **Update any other test files** that import from `tests.grids` or `tests.harness`.

### Scope check

`speednik/agents/` (from S-010) already defines programmed agents that duplicate some
strategy logic. Verify there's no conflict — strategies.py should be the single source,
and agents can import from it if needed.

### Location

New files: `speednik/grids.py`, `speednik/strategies.py`
Modified: `speednik/devpark.py`, `tests/grids.py`, `tests/harness.py`, test files with
direct imports.

## Acceptance Criteria

- [ ] `speednik/grids.py` contains all grid builders, importable at runtime
- [ ] `speednik/strategies.py` contains all strategy functions and runner
- [ ] `speednik/devpark.py` imports from `speednik.grids` and `speednik.strategies`
- [ ] Dev park launches without `ModuleNotFoundError` (both `uv run` and debug mode)
- [ ] `tests/grids.py` and `tests/harness.py` re-export from new locations
- [ ] All existing test files pass without import changes (re-export shims work)
- [ ] No duplicate code between strategies.py and agents/
- [ ] `uv run pytest tests/ -x` passes
- [ ] `SPEEDNIK_DEBUG=1 uv run python -m speednik.main` launches dev park without error
