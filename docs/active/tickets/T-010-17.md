---
id: T-010-17
story: S-010
title: full-observation-vector
type: task
status: open
priority: high
phase: done
depends_on: [T-010-16]
---

## Context

Integrate the directional raycast (T-010-16) into the observation extraction function to
produce the full 26-dimensional observation vector described in the spec. Then update the
Gymnasium environment's observation space to match.

See `docs/specs/scenario-testing-system.md` §3.2 for the full observation layout.

### Full 26-dim observation vector

```python
OBS_DIM = 26

def extract_observation(sim: SimState) -> np.ndarray:
    p = sim.player.physics
    obs = np.zeros(OBS_DIM, dtype=np.float32)

    # Player kinematics (6 values) — indices 0-5
    obs[0] = p.x / sim.level_width
    obs[1] = p.y / sim.level_height
    obs[2] = p.x_vel / MAX_X_SPEED
    obs[3] = p.y_vel / MAX_X_SPEED
    obs[4] = float(p.on_ground)
    obs[5] = p.ground_speed / MAX_X_SPEED

    # Player state (3 values) — indices 6-8
    obs[6] = float(p.is_rolling)
    obs[7] = float(p.facing_right)
    obs[8] = p.angle / 255.0

    # Progress (3 values) — indices 9-11
    obs[9]  = sim.max_x_reached / sim.level_width
    obs[10] = (sim.goal_x - p.x) / sim.level_width
    obs[11] = float(sim.frame) / 3600.0

    # Terrain raycasts (7 rays × 2 = 14 values) — indices 12-25
    ray_angles = [-45, -30, -15, 0, 15, 30, 45]
    max_ray_range = 128.0
    for i, angle_deg in enumerate(ray_angles):
        # Flip ray direction if facing left
        effective_angle = angle_deg if p.facing_right else (180 - angle_deg)
        dist, surf_angle = cast_terrain_ray(
            sim.tile_lookup, p.x, p.y - 8,  # ray origin at player center
            effective_angle, max_ray_range
        )
        obs[12 + i * 2]     = dist / max_ray_range
        obs[12 + i * 2 + 1] = surf_angle / 255.0

    return obs
```

### Environment update

Update `SpeednikEnv.observation_space` shape from `(12,)` to `(26,)`. Update `OBS_DIM`.
This is the only change needed in `env.py` — the observation extraction function is called
indirectly.

### Backward compatibility

The 12-dim observation (without raycasts) should remain available as a configuration option
for faster training experiments where raycasts aren't needed:

```python
class SpeednikEnv(gym.Env):
    def __init__(self, stage="hillside", render_mode=None, max_steps=3600,
                 use_raycasts=True):
        self.use_raycasts = use_raycasts
        obs_dim = 26 if use_raycasts else 12
        self.observation_space = spaces.Box(..., shape=(obs_dim,), ...)
```

### Re-register environments

Update registrations to default to full observations. Optionally register `-NoRay-v0`
variants for the simplified observation:

```python
gym.register(id="speednik/Hillside-v0", ..., kwargs={"stage": "hillside"})
gym.register(id="speednik/Hillside-NoRay-v0", ..., kwargs={"stage": "hillside", "use_raycasts": False})
```

### Validation

- Run `check_env` again with the 26-dim observation
- Run a 10K-step PPO smoke test with full observations — verify no NaN/Inf in observations
- Compare learning curves: 12-dim vs 26-dim over a short training run (informational, not
  a gate)

### Re-baseline

After the observation space changes, the baseline results JSON from T-010-13 must be
regenerated. The metrics won't change (they're computed from sim state, not observations),
but the `total_reward` may shift slightly if reward computation is affected by observation
quality.

### Location

- `speednik/observation.py` — update extract_observation with raycasts
- `speednik/env.py` — update OBS_DIM, add use_raycasts parameter
- `speednik/env_registration.py` — add NoRay variants

## Acceptance Criteria

- [ ] `extract_observation` returns 26-dim vector with raycast data
- [ ] 7 rays at [-45, -30, -15, 0, 15, 30, 45] degrees relative to facing direction
- [ ] Ray distances normalized by max_range (0 to 1)
- [ ] Ray surface angles normalized by 255 (0 to 1)
- [ ] Ray direction flips when player faces left
- [ ] `SpeednikEnv` observation_space shape is (26,)
- [ ] `use_raycasts=False` option produces 12-dim observations
- [ ] `check_env` passes with 26-dim observations
- [ ] No NaN/Inf in observations during 1000-step random play
- [ ] PPO smoke test (10K steps) works with full observations
- [ ] NoRay environment variants registered
- [ ] Baseline regenerated with full observations
- [ ] No Pyxel imports
- [ ] `uv run pytest tests/ -x` passes
