---
id: T-007-01
story: S-007
title: svg2stage-loop-entry-exit-ramps
type: task
status: open
priority: critical
phase: done
depends_on: []
---

## Context

The `_rasterize_loop` function in `tools/svg2stage.py` rasterizes the loop circle faithfully
but generates no transition geometry between flat ground and the ascending/descending arcs.
The player's ground angle stays at 0° (quadrant 0), wall sensors fire on steep arc tiles,
and the loop is impassable.

### What needs to happen

Add quarter-circle transition arcs at loop entry (left) and exit (right) that smoothly
connect the flat ground surface to the loop circle's tangent point.

### Ramp geometry

The loop circle has center `(cx, cy)` and radius `r`. The bottom of the circle is at
`y = cy + r` (ground level). At the bottom-left point `(cx - r, cy)`, the circle's tangent
is vertical (pointing straight up). The ramp must transition from horizontal (angle 0°) to
this vertical tangent.

**Entry ramp (left side):**
- A quarter-circle arc of radius `r_ramp` (proportional to loop radius, e.g. `r_ramp = r`)
- The ramp arc center is at `(cx - r, cy)` — the leftmost point of the loop circle
- The ramp starts at ground level (`y = cy + r`) at x-position `cx - r - r_ramp`
- The ramp ends at the loop circle's left tangent point `(cx - r, cy)`
- Angle transitions smoothly from 0° at ground level through increasing values

**Exit ramp (right side):**
- Symmetric to entry: quarter-circle arc from loop's right tangent point `(cx + r, cy)` down
  to ground level at `(cx + r + r_ramp, cy + r)`

### Ramp tile properties

Each ramp tile gets:
- `surface_type = SURFACE_SOLID` (type 1) — ramp tiles are regular ground, not loop tiles
- `height_array` computed from the ramp arc's analytical y-position per pixel column
- `angle` computed from the ramp arc's tangent at that pixel column
- `solidity = FULL` (2) — solid ground the player runs on
- Ground fill below the ramp surface (same as regular terrain)

### Angle computation for ramp tiles

For a quarter-circle ramp arc centered at `(arc_cx, arc_cy)` with radius `r_ramp`:
- At pixel column `px`, compute `dx = px - arc_cx`, `dy = sqrt(r_ramp² - dx²)`
- Surface y = `arc_cy + dy` (entry) or `arc_cy + dy` (exit, mirrored)
- Tangent angle = `atan2(dx, dy)` mapped to the 256-step byte angle system
- Entry ramp: angles progress from ~0° (bottom, flat) to ~64° (top, vertical)
- Exit ramp: angles progress from ~192° (top) to ~0° (bottom, flat)

### Integration with existing `_rasterize_loop`

The ramp generation should be added to `_rasterize_loop` (or a helper called from it).
The ramps are generated BEFORE the loop circle itself so that any overlapping tiles at the
tangent point are overwritten by the loop's own tiles (loop tiles take priority).

The existing hollow-interior logic and ground fill below the loop should continue to work
unchanged. The ramps only add new tiles outside the loop circle's x-range.

## Acceptance Criteria

- [ ] `_rasterize_loop` (or a new helper it calls) generates entry ramp tiles to the left
  of the loop circle and exit ramp tiles to the right
- [ ] Ramp tiles have gradually increasing angles from 0° at ground level to ~64° at the
  loop tangent point (entry) and ~192° to ~0° (exit)
- [ ] Ramp tiles have correct `height_array` values computed from the arc equation
- [ ] Ramp tiles have `solidity = FULL` and ground fill beneath them
- [ ] No tile gaps between ramp tiles and the loop circle tiles at the tangent points
- [ ] Ramp radius is proportional to loop radius (default: `r_ramp = r`)
- [ ] `uv run python tools/svg2stage.py stages/hillside_rush.svg speednik/stages/hillside/`
  runs successfully
- [ ] Validation report shows zero "Impassable gap" errors at ramp-to-loop junctions
- [ ] `uv run pytest tests/test_svg2stage.py -x` passes (add ramp-specific tests if the
  test file exists; otherwise verify via validation report)
