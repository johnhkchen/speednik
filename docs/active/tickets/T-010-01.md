---
id: T-010-01
story: S-010
title: simstate-and-create-sim
type: task
status: open
priority: high
phase: done
depends_on: [T-009-03, T-009-04, T-009-05]
---

## Context

Build the `SimState` dataclass and the `create_sim()` factory that loads a real stage into a
complete headless game state. This is Layer 2 of the architecture — the foundation everything
else builds on.

`SimState` captures everything `main.py:App` tracks during gameplay, minus rendering and
audio state. It holds the player, tile lookup, all object lists (rings, springs, checkpoints,
pipes, liquid zones, enemies), goal position, level dimensions, frame counter, and metric
accumulators.

See `docs/specs/scenario-testing-system.md` §2.3 for the full dataclass definition.

### SimState dataclass

```python
@dataclass
class SimState:
    player: Player
    tile_lookup: TileLookup
    rings: list[Ring]
    springs: list[Spring]
    checkpoints: list[Checkpoint]
    pipes: list[LaunchPipe]
    liquid_zones: list[LiquidZone]
    enemies: list[Enemy]
    goal_x: float
    goal_y: float
    level_width: int
    level_height: int
    frame: int = 0
    max_x_reached: float = 0.0
    rings_collected: int = 0
    deaths: int = 0
    goal_reached: bool = False
    player_dead: bool = False
```

### create_sim factory

```python
def create_sim(stage_name: str) -> SimState:
    stage = load_stage(stage_name)
    sx, sy = stage.player_start
    player = create_player(float(sx), float(sy))
    # Load all entity types from stage.entities
    # Extract goal position from entities
    return SimState(...)
```

This mirrors `main.py:_start_gameplay()` lines 244-294 — the same entity loading calls
(`load_rings`, `load_springs`, `load_checkpoints`, `load_pipes`, `load_liquid_zones`,
`load_enemies`), same goal extraction, same boss injection for stage 3.

### Event types

Define the event sum type that `sim_step` (T-010-02) will return:

```python
@dataclass
class RingCollectedEvent: pass
@dataclass
class DamageEvent: pass
@dataclass
class DeathEvent: pass
@dataclass
class SpringEvent: pass
@dataclass
class GoalReachedEvent: pass
@dataclass
class CheckpointEvent: pass

Event = RingCollectedEvent | DamageEvent | DeathEvent | SpringEvent | GoalReachedEvent | CheckpointEvent
```

### Location

`speednik/simulation.py` — new file.

## Acceptance Criteria

- [ ] `SimState` dataclass with all fields from the spec
- [ ] `create_sim("hillside")` returns a fully populated SimState
- [ ] `create_sim("pipeworks")` and `create_sim("skybridge")` also work
- [ ] Goal position correctly extracted from stage entities
- [ ] Stage 3 boss entity injected
- [ ] All entity lists populated (rings, springs, checkpoints, pipes, liquid, enemies)
- [ ] Event types defined
- [ ] No Pyxel imports
- [ ] `uv run pytest tests/ -x` passes
