---
id: T-006-04
story: S-006
title: profile2stage-wave-halfpipe
type: task
status: open
priority: medium
phase: done
depends_on: [T-006-02]
---

## Context

Add `wave` and `halfpipe` segment types to `profile2stage.py`. Both produce non-linear
ground profiles that the LLM describes with a small set of parameters rather than
enumerating individual tile heights.

### wave segment

```json
{"seg": "wave", "len": 1000, "amplitude": 50, "period": 400, "id": "hills"}
```

Generates sinusoidal terrain. Ground height at offset `dx` from segment start:
```
y(dx) = cursor_y + amplitude * sin(2π * dx / period)
```

At `dx=0` and `dx=period`, the terrain returns to `cursor_y` (tangent is flat, slope=0).
At `dx=period/4`, the terrain peaks at `cursor_y - amplitude` (hill).
At `dx=3*period/4`, the terrain troughs at `cursor_y + amplitude` (valley).

**Floor clamping:** If `y(dx) > height - TILE_SIZE` (terrain would push below level floor),
clamp to `height - TILE_SIZE` and emit a warning:
```
WARNING: wave segment 'hills' clamps below level floor at offset dx=N (y=Y > floor=F)
```

**Slope constraint:** The maximum instantaneous slope is `2π * amplitude / period`. Emit
a warning (not an error) if this exceeds `tan(30°)`. The level is still generated; the
warning lets the LLM know the terrain may feel steep.

**Cursor exit:** At `dx=len`, the cursor exits at height `y(len)` with slope `dy/dx` at
that point. If `len` is not a multiple of `period`, the exit slope may be non-zero; the
synthesizer correctly threads this slope into the next segment's tangent state.

**Tile height arrays:** Computed column-by-column using the analytic formula. No
pixel-sampled walk needed — each tile column's height is `round(y(dx) - tile_bottom_y)`,
using the same `math.ceil` convention as T-006-01/T-006-03.

### halfpipe segment

```json
{"seg": "halfpipe", "len": 400, "depth": 80, "id": "valley_1"}
```

Generates a U-shaped depression. Uses a cosine profile:
```
y(dx) = cursor_y + depth * (1 - cos(π * dx / len)) / 2
```

At `dx=0`: y = cursor_y (entry, slope=0, tangent matches adjacent flat/ramp).
At `dx=len/2`: y = cursor_y + depth (lowest point).
At `dx=len`: y = cursor_y (exit, slope=0).

This ensures the halfpipe always enters and exits at ground level with zero slope,
regardless of depth. No floor clamping needed as long as `cursor_y + depth < height - TILE_SIZE`;
validate this and error if violated.

**Slope constraint:** Maximum instantaneous slope is `π * depth / (2 * len)`. Warn if
this exceeds `tan(30°)`.

### Height array generation (shared utility)

Both segments share a height-profile-to-tiles function:
```python
def _rasterize_height_profile(
    profile_fn: Callable[[float], float],  # offset_x → surface_y
    x_start: int,
    x_end: int,
    grid: TileGrid,
    surface_type: int,
) -> None
```

This function iterates over pixel columns from `x_start` to `x_end`, calls `profile_fn(dx)`,
and sets `tile.height_array[col]` using `math.ceil(tile_bottom_y - surface_y)`. Then
calls `_fill_interior` for the covered columns.

This utility will also be reused if `flat` and `ramp` are refactored to use it, which is
optional for this ticket but should be considered for code reuse.

## Acceptance Criteria

- [ ] `wave` segment implemented with parameters `len`, `amplitude`, `period`
- [ ] `wave` segment produces sinusoidal height profile matching the formula above
- [ ] `wave` floor clamping warns and clamps when terrain would go below `height - TILE_SIZE`
- [ ] `wave` slope warning emitted when max slope > tan(30°)
- [ ] `wave` cursor exits with correct y and slope for non-multiple-of-period lengths
- [ ] `halfpipe` segment implemented with parameters `len`, `depth`
- [ ] `halfpipe` entry and exit at `cursor_y` with zero slope
- [ ] `halfpipe` errors if `cursor_y + depth >= height - TILE_SIZE`
- [ ] `halfpipe` slope warning emitted when max slope > tan(30°)
- [ ] Shared `_rasterize_height_profile` utility used by both segment types
- [ ] `math.ceil` used for all height calculations
- [ ] `uv run pytest tests/test_profile2stage.py -x` passes with new wave/halfpipe tests:
  - Wave peak height matches formula at `dx=period/4`
  - Wave trough depth matches formula at `dx=3*period/4`
  - Halfpipe returns to `cursor_y` at entry and exit
  - Halfpipe depth correct at midpoint
  - Floor clamp warning triggered correctly for wave
  - Halfpipe error raised when depth exceeds available space
