---
id: T-011-02
story: S-011
title: physics-invariant-checker
type: task
status: open
priority: high
phase: done
depends_on: [T-010-02]
---

## Context

Build a reusable invariant checker that scans a simulation trajectory and flags impossible
physics states. This is the "if a player doing naive controls can experience a weird
behavior, that's probably a bug" detector.

### Invariants to check

**Position invariants:**
- Player X never negative
- Player Y never exceeds `level_height + 64` (fell through the world)
- Player X never exceeds `level_width + 64` (escaped right boundary)
- Player is never inside a fully solid tile (center point resolves to solid)

**Velocity invariants:**
- `|x_vel|` never exceeds a sane maximum (e.g. 20.0 — well beyond spindash top speed)
- `|y_vel|` never exceeds a sane maximum (e.g. 20.0 — terminal velocity cap)
- No single-frame velocity spike: `|delta_vel|` between consecutive frames shouldn't
  exceed a threshold unless a spring/spindash event occurred that frame

**State invariants:**
- Player state is DEAD only if rings were 0 at time of damage OR fell out of bounds
- `on_ground` is True only if Y position corresponds to a surface (not floating in air
  with no tile below)
- Quadrant transitions are smooth: no jumping from quadrant 0 to quadrant 2 in a single
  frame without passing through 1 or 3 (indicates collision glitch)

### API

```python
@dataclass
class Violation:
    frame: int
    invariant: str  # name of the violated invariant
    details: str    # human-readable description
    severity: str   # "error" or "warning"

def check_invariants(
    sim: SimState,
    snapshots: list[FrameSnapshot],
    events_per_frame: list[list[Event]],
) -> list[Violation]:
    """Scan a trajectory for physics invariants. Returns violations."""
```

### Integration pattern

The checker is a library, not a test. Tests import it and assert `len(violations) == 0`
(or filter by severity). This way T-011-06 can reuse it across all stage × strategy combos.

### Location

`speednik/invariants.py` — new module (part of the package, not tests, so it can be
reused by the scenario runner and CI).

`tests/test_invariants.py` — unit tests for the checker itself using synthetic trajectories
with known violations.

## Acceptance Criteria

- [ ] `Violation` dataclass with frame, invariant name, details, severity
- [ ] `check_invariants` detects player out of bounds (X and Y)
- [ ] `check_invariants` detects velocity spikes
- [ ] `check_invariants` detects player inside solid tile
- [ ] `check_invariants` detects impossible quadrant jumps
- [ ] Unit tests with synthetic violations (crafted FrameSnapshots)
- [ ] Unit tests with clean trajectories (assert 0 violations)
- [ ] No Pyxel imports
- [ ] `uv run pytest tests/test_invariants.py -x` passes
