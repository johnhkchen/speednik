---
id: T-006-03
story: S-006
title: profile2stage-loop-segment
type: task
status: open
priority: high
phase: done
depends_on: [T-006-01, T-006-02]
---

## Context

Add the `loop` segment type to `profile2stage.py`. The loop segment generates a full 360°
loop with guaranteed-hollow interior and no 1px side-arc gaps.

This ticket depends on T-006-01 because it reuses the analytical arc-tile intersection
approach validated there: iterate over each pixel column within the circle's x-range,
compute the exact y intersection analytically (rather than sampling segment points), and
use `math.ceil` for height rounding. This is the same math that fixes the SVG loop gaps,
now applied from the start in the profile synthesizer.

### Schema

```json
{"seg": "loop", "radius": 128, "id": "main_loop"}
```

- `radius`: circle radius in pixels. Must be ≥ 32 (minimum viable loop for physics).
  Warn if < 64 (physics may be unstable at low radius). Error if < 32.
- No `len` field: the loop's horizontal footprint is `2 * radius`. The cursor advances
  by `2 * radius` after the loop.

### Geometry

The loop circle center is positioned such that:
- The bottom of the loop (`cy + radius`) sits at `cursor_y` (current ground level)
- Therefore `cy = cursor_y - radius`
- `cx = cursor_x + radius` (center of the loop's footprint)

The loop tiles cover:
- Bottom arc (lower half, `sy >= cy`): `is_loop_upper = False`, solidity `FULL`
- Upper arc (upper half, `sy < cy`): `is_loop_upper = True`, solidity `TOP_ONLY`

The ground under the loop (below `cursor_y`) is filled solid by a ground polygon spanning
the loop's x footprint at `cursor_y`. This ensures the player can stand under the loop
when not going fast enough to traverse it.

### Tangent matching

The loop's left entry tangent is always vertical (slope = ∞ going upward). The adjacent
segment is typically `flat` (slope = 0). The synthesizer must insert a transition arc
at the loop entry and exit:
- Entry: a short quarter-circle arc that transitions from `cursor_slope` (flat = 0) to the
  loop's entry tangent. This arc rises the player from ground level to the loop entry point.
- Exit: symmetric arc descending from loop exit back to `cursor_y`.

The transition arcs are computed analytically: a circular arc of radius proportional to
the slope difference, tangent-matched at both endpoints. The cursor advances by the arc's
horizontal extent on each side before and after the loop circle.

If `cursor_slope` is already non-zero (ramp leading into loop), the transition arc is
shorter (less slope difference to bridge).

### Hollow interior guarantee

`_fill_interior` must not flood the hollow interior of the loop. This is achieved by:
1. Loop tiles have `surface_type = SURFACE_LOOP`
2. Any `_fill_interior` pass for SOLID terrain stops when it encounters a LOOP tile in the
   same column. This is the existing svg2stage.py behavior — profile2stage.py inherits it.
3. The loop synthesizer does NOT call `_fill_interior` for the loop circle itself (same
   as `_rasterize_loop` in svg2stage.py).

### Arc angle computation

For each tile, the `angle` field must reflect the tangent direction of the arc at that
point (not a constant). This is necessary for the physics engine's quadrant-mode switching.

For a circle at `(cx, cy)` with radius `r`, at pixel column `px`:
- Bottom arc tangent (player running rightward on inside floor): the tangent points in the
  direction of the arc's rightward traversal. At bottom-center the tangent is rightward
  (angle 0); at left-side the tangent is downward (angle 192); at right-side it is upward
  (angle 64).
- Use `_compute_segment_angle` with synthetic tangent vectors derived from the arc geometry.

## Acceptance Criteria

- [ ] `loop` segment type recognized and handled in `profile2stage.py`
- [ ] Loop center computed as `cy = cursor_y - radius`, `cx = cursor_x + radius`
- [ ] Cursor advances by `2 * radius` (plus transition arc extents) after the loop
- [ ] Arc rasterization uses analytical per-pixel-column approach with `math.ceil` height
- [ ] No tile gaps on loop sides (verified by post-rasterization Validator check on the
  output — zero "Impassable gap" errors in loop-side columns)
- [ ] Loop interior is hollow (no solid tiles within the circle that aren't on the perimeter)
- [ ] Upper arc tiles have `is_loop_upper = True` → `TOP_ONLY` in collision.json
- [ ] Lower arc tiles have `is_loop_upper = False` → `FULL` in collision.json
- [ ] Ground fill under the loop (below `cursor_y`) is solid, connecting loop base to ground
- [ ] Transition arcs inserted at loop entry/exit for slope-0 (flat) adjacent segments
- [ ] Error raised if `radius < 32`; warning if `radius < 64`
- [ ] `uv run pytest tests/test_profile2stage.py -x` passes with new loop tests:
  - Loop with flat approach/exit produces no gap errors
  - Loop interior is hollow (sample tiles at cx, cy are not solid)
  - Upper/lower arc solidity flags are correct
  - Cursor position is correct after a loop segment
