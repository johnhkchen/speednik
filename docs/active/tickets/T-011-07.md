---
id: T-011-07
story: S-011
title: ci-pytest-gate
type: task
status: open
priority: high
phase: done
depends_on: [T-011-06]
---

## Context

Wire up GitHub Actions (or equivalent) to run the full pytest suite on every push and PR.
The regression suite from T-011-06 is the crown jewel, but all existing tests should run
too.

### CI configuration

```yaml
# .github/workflows/test.yml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync
      - run: uv run pytest tests/ -x --tb=short
```

### Requirements

- **No Pyxel dependency in CI.** All tests must be Pyxel-free (they already are — the
  architecture ensures this). Verify `import pyxel` never appears in test files or in any
  module imported during testing.
- **Fast enough.** The regression suite runs 9 (stage × strategy) combos at ~3000 frames
  each. At the benchmarked ~20K+ updates/sec, that's < 2 seconds total. The full test suite
  should complete in under 30 seconds.
- **Deterministic.** No flaky tests. The physics engine is fully deterministic given the
  same inputs. Assert exact thresholds, not probabilistic ones.

### Stretch: test markers

Add pytest markers for test categorization:
- `@pytest.mark.smoke` — walkthrough smoke tests (fast, catch gross regressions)
- `@pytest.mark.regression` — full regression suite (medium, the main gate)
- `@pytest.mark.slow` — benchmarks or exhaustive tests (optional in CI)

### Location

`.github/workflows/test.yml` — new file.
`pyproject.toml` — add pytest marker configuration if using markers.

## Acceptance Criteria

- [ ] GitHub Actions workflow runs pytest on push and PR
- [ ] All tests pass in CI (no Pyxel dependency issues)
- [ ] CI completes in under 60 seconds
- [ ] Deterministic — no flaky tests across 3 consecutive runs
- [ ] `uv run pytest tests/ -x` passes locally before CI setup
