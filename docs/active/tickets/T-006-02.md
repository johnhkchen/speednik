---
id: T-006-02
story: S-006
title: profile2stage-core
type: task
status: done
priority: high
phase: done
depends_on: []
---

## Context

Build the foundational layer of the LLM-native level authoring tool: `tools/profile2stage.py`.
This ticket covers the cursor state machine, the track JSON schema definition, the minimum
viable segment vocabulary (flat/ramp/gap), the CLI entry point, and output writing.

The tool reads a `.profile.json` file and emits the same four files that `svg2stage.py`
produces (`tile_map.json`, `collision.json`, `entities.json`, `meta.json`), so the game
engine loads profile-generated stages identically to SVG-generated ones. The validation
report output is also the same format.

### Schema (MVP subset — full schema documented in T-006-05)

```json
{
  "width": 4800,
  "height": 720,
  "start_y": 636,
  "track": [
    {"seg": "flat", "len": 600, "id": "opening"},
    {"seg": "ramp", "len": 100, "rise": -50, "id": "slope_up"},
    {"seg": "gap",  "len": 32,  "id": "first_pit"},
    {"seg": "flat", "len": 400, "id": "landing"}
  ]
}
```

Field constraints:
- `width`, `height`: positive integers (pixels). Default height 720.
- `start_y`: ground level y at the start of the track. Default 636.
- `seg.len`: segment length in pixels, must be > 0.
- `seg.rise` (ramp only): signed pixel delta in y over the segment length. Positive = descend
  (y increases in screen coords), negative = ascend. `abs(rise/len)` must not exceed the
  maximum passable slope ratio (tan(45°) = 1.0). Warn if > tan(30°).
- `seg.id` (optional): anchor name for overlays and entities. Must be unique if provided.
  Auto-generated IDs (`seg_0`, `seg_1`, ...) assigned when omitted.

### Cursor state machine

The synthesizer maintains:
- `cursor_x`: current x position in pixels, starts at 0
- `cursor_y`: current y position (ground surface level), starts at `start_y`
- `cursor_slope`: current ground slope (rise/run ratio), starts at 0.0

For each segment:
1. Compute segment geometry (segment-type specific)
2. Rasterize segment tiles into the grid (flat segments: horizontal height array; ramp: linear
   interpolation from cursor_y to cursor_y+rise across len columns)
3. Apply fill_interior below the surface
4. Advance cursor_x by `len`, cursor_y by `rise` (0 for flat/gap), cursor_slope to new value

### Tangent matching (stub for MVP)

If adjacent segments have a slope discontinuity, log a warning with the segment IDs and
slope values. Auto-inserted transition arcs are deferred to T-006-03 (loop) when the full
arc math is available. MVP just warns; it does not reject.

### Output

- `tile_map.json`, `collision.json`, `entities.json`, `meta.json`: same schema as svg2stage.py
- `validation_report.txt`: pre-rasterization warnings (slope limit exceeded, etc.) followed
  by post-rasterization issues (impassable gaps, accidental walls) using the same Validator
  from svg2stage.py

### CLI

```
python tools/profile2stage.py input.profile.json output_dir/
```

## Acceptance Criteria

- [ ] `tools/profile2stage.py` exists as a standalone CLI with the usage above
- [ ] Reads `.profile.json` and validates required fields (`track`, `width`, `height`, `start_y`)
- [ ] Implements `flat` segment: horizontal ground, advances cursor by `len`
- [ ] Implements `ramp` segment: linear slope from current y to y+rise, advances cursor
- [ ] Implements `gap` segment: no tiles generated, advances cursor by `len`
- [ ] Each segment assigned a unique `id` (explicit or auto-generated)
- [ ] Cursor state (x, y, slope) correctly threaded through all segment types
- [ ] `fill_interior` applied below surface tiles (flat and ramp only, not gap)
- [ ] Outputs `tile_map.json`, `collision.json`, `entities.json`, `meta.json`, `validation_report.txt`
- [ ] `entities.json` is an empty list for this ticket (entities handled in T-006-05)
- [ ] `meta.json` includes `player_start: null` when no player_start entity defined
- [ ] `uv run pytest tests/test_profile2stage.py -x` passes (new test file):
  - flat segment produces height_array of [16]*16 for all tiles
  - ramp segment produces linearly interpolated heights
  - gap segment produces no tiles
  - cursor_y is correctly advanced by ramp rise values
  - output files are written and parseable JSON
- [ ] Slope warning emitted when `abs(rise/len) > tan(30°)`
- [ ] Error raised (not silent) when `abs(rise/len) > 1.0` (unpassable slope)
