---
id: T-002-01
story: S-002
title: svg-to-stage-pipeline
type: task
status: open
priority: high
phase: done
depends_on: [T-001-03]
---

## Context

Build the SVG-to-stage pipeline as a standalone CLI tool. This converts designer-drawn SVG files into the tile map, collision data, and entity placement that the engine loads.

Reference: docs/specification.md section 4

## Acceptance Criteria

- [ ] `tools/svg2stage.py` is a standalone CLI: `python tools/svg2stage.py input.svg output_dir/`
- [ ] Parses SVG terrain geometry:
  - Closed polygons/polylines with stroke color → surface type mapping (#00AA00=solid, #0000FF=top-only, #FF8800=slope, #FF0000=hazard)
  - Circles/ellipses → loop tile sequences with continuous angle values
  - Fill color ignored, only stroke color and path geometry matter
- [ ] Parses SVG entities:
  - `<circle>`/`<rect>` elements with `id` attribute → entity type (ring, enemy_crab, enemy_buzzer, enemy_chopper, spring_up, spring_right, goal, checkpoint, pipe_h, pipe_v, liquid_trigger, player_start)
  - Position from element center point
- [ ] ViewBox maps to world pixel space at 1:1
- [ ] Rasterization:
  - Straight segments → tile grid with angle from segment slope (0–255 format)
  - Curved paths → sample at 16px intervals, tangent angle per sample
  - Loops → walk ellipse perimeter at 16px intervals, flag upper-half tiles for quadrant mode switching
  - Height arrays computed from SVG geometry occupancy per tile column (45° diagonal → linear 0–16 array)
- [ ] Outputs per stage:
  - `tile_map.json`: 2D array of {type, height_array, angle}
  - `collision.json`: solidity flags per tile
  - `entities.json`: flat array of {type, x, y}
  - `meta.json`: stage width, height, player_start, checkpoints
  - `validation_report.txt`: all flagged issues
- [ ] Validation checks:
  - Angle inconsistency > 30° between neighbors
  - Terrain gaps < 18px that aren't top-only
  - Slope sequences > 45° for > 3 tiles without loop flag
- [ ] Test with a minimal SVG containing flat ground, a slope, and a few entities
