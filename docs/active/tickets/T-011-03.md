---
id: T-011-03
story: S-011
title: geometric-feature-probes
type: task
status: open
priority: high
phase: done
depends_on: [T-011-01]
---

## Context

Targeted tests against specific geometric features in real stages. Unlike the walkthrough
smoke tests (T-011-01) which just check "does the player get through", these tests probe
**individual features** at known coordinates and assert specific physics outcomes.

If stage data is regenerated (e.g. svg2stage or profile2stage rerun), these tests catch
geometry regressions at the feature level.

### Feature probes

**Loop traversal (hillside):**
- Place player before the loop with enough speed (spindash).
- Assert `quadrants_visited` includes all 4 quadrants (0, 1, 2, 3).
- Assert player exits the loop moving right with positive ground_speed.
- Assert player Y after exit is approximately equal to Y before entry (returned to ground).

**Spring launch (all stages with springs):**
- Place player on top of a spring. Step until launch.
- Assert SpringEvent fired.
- Assert player Y decreased (launched upward) by at least the expected spring impulse.
- Assert player lands back on solid ground within a reasonable frame window.

**Gap clearing (pipeworks, skybridge):**
- Identify gaps in the terrain. Place player before gap with hold_right_jump.
- Assert player X crosses the gap without death.
- Assert player Y stays above the death threshold throughout.

**Ramp transitions:**
- Run player across slope transitions (flat→ramp, ramp→flat).
- Assert no velocity zeroing (player doesn't slam into the slope like a wall).
- Assert angle changes are smooth frame-to-frame.

**Checkpoint activation:**
- Run player through a checkpoint location.
- Assert CheckpointEvent fires.

### Discovery

The walkthrough tests from T-011-01 will reveal which X coordinates correspond to
features (loops show quadrant changes, springs show velocity spikes, gaps show airborne
sections). Use those trajectories to identify probe coordinates. Document the coordinates
in test comments so future stage regeneration can update them if geometry shifts.

### Location

`tests/test_geometry_probes.py` — new file.

## Acceptance Criteria

- [ ] Loop probe: spindash through hillside loop, all 4 quadrants visited
- [ ] Loop probe: player exits with positive ground_speed and returns to ground level
- [ ] Spring probe: spring launch detected, player gains expected height
- [ ] Gap probe: player clears at least one gap per stage with hold_right_jump
- [ ] Ramp probe: no velocity zeroing on slope transitions
- [ ] Checkpoint probe: CheckpointEvent fires when player reaches checkpoint
- [ ] Probe coordinates documented in comments for maintainability
- [ ] `uv run pytest tests/test_geometry_probes.py -x` passes
