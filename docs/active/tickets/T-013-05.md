---
id: T-013-05
story: S-013
title: loop-and-slope-surface-adhesion
type: bug
status: open
priority: high
phase: done
depends_on: []
---

## Context

The physics engine cannot maintain ground contact on steep curved or angled surfaces:

1. **Loops**: Players detach at the Q1→Q2 (wall-to-ceiling) transition and fly over the
   loop aerially. No synthetic loop at any radius (32, 48, 64, 96) achieves full 4-quadrant
   grounded traversal. Q2 (ceiling, byte angles 97–160) is never reached while grounded.

2. **Steep slopes**: Ground adhesion fails at byte angle ≥ 35 (~49°). On_ground drops to
   ~50% in the slope region. The slip system activates at SLIP_ANGLE_THRESHOLD=33.

3. **Large loop exit overshoot**: For radius ≥ 64, the aerial trajectory after detachment
   overshoots the exit tiles entirely (secondary consequence of the Q1→Q2 detachment).

Addresses: T-012-06-BUG-01, T-012-06-BUG-02, T-012-06-BUG-03.

## Root cause analysis needed

The Sonic 2 engine uses speed-based ground adhesion: the player stays attached to curved
surfaces when `ground_speed` exceeds a threshold relative to the surface angle. Key
mechanisms to investigate:

- **Ground speed vs angle check**: Does `player_update` correctly compare ground_speed
  against the adhesion threshold at high angles? The original Sonic 2 uses different
  fall/detach thresholds per quadrant.
- **Angle transition smoothness**: Do `build_loop` tiles produce smooth enough angle
  progressions for the collision system to track the surface? Abrupt angle jumps may
  cause the floor sensor to lose contact.
- **Quadrant switching**: Does the player correctly switch from Q1 (right wall) mode to
  Q2 (ceiling) mode? The sensor rotation and ground-speed-to-velocity decomposition
  must update at the quadrant boundary.
- **Slope slip threshold**: Is SLIP_ANGLE_THRESHOLD=33 correct for Sonic 2? The original
  uses different thresholds for slipping vs falling off.

## Requirements

1. Research the original Sonic 2 ground adhesion / loop lock mechanics (SPG or disassembly
   reference).

2. Identify which adhesion checks are missing or incorrect in `player_update` / physics.

3. Implement the fix. Likely candidates:
   - Add speed-based adhesion check that prevents detachment when ground_speed > threshold
   - Fix quadrant transition logic at Q1→Q2 boundary
   - Adjust or split SLIP_ANGLE_THRESHOLD for slip vs detach cases

4. Verify `build_loop` angle arrays produce valid progressions (fix if needed).

5. For slope adhesion: determine if byte angle 35 failure is a slip-system issue or a
   height-array discontinuity issue, and fix accordingly.

## Acceptance Criteria

- Synthetic loop (radius=48) achieves 4-quadrant traversal: quadrants_visited = {0,1,2,3}
- Synthetic loop (radius=64) player lands on exit tiles (no overshoot)
- Slope adhesion at byte angle 35: on_ground ≥ 80% in slope region
- Hillside loop traversal test passes (not xfail)
- No regressions on existing passing tests
