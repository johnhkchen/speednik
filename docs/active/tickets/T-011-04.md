---
id: T-011-04
story: S-011
title: camera-stability-tests
type: task
status: open
priority: high
phase: done
depends_on: [T-010-02]
---

## Context

The camera system (`speednik/camera.py`) tracks the player with speed-dependent scrolling,
lookahead borders, and vertical focal points. When the player moves through slopes, loops,
or springs, the camera can wobble or oscillate if the tracking logic fights the physics.

This ticket tests camera stability by running strategies on real stages with camera updates
and asserting smooth, bounded behavior.

### Camera integration

`sim_step` currently does not update the camera (matching `_update_gameplay` which calls
`camera_update` separately). The test harness will create a Camera alongside the SimState
and call `camera_update(camera, sim.player, inp)` after each `sim_step`. This keeps the
simulation module clean while still testing camera behavior.

```python
from speednik.camera import Camera, camera_update, create_camera

camera = create_camera(level_width, level_height)
for frame in range(frames):
    events = sim_step(sim, inp)
    camera_update(camera, sim.player, inp)
    # record camera.x, camera.y
```

### Stability assertions

**No wobble (oscillation detection):**
- Compute `delta_x = camera.x[f] - camera.x[f-1]` for each frame.
- Flag if `sign(delta_x)` flips more than N times within a W-frame window (e.g. 5 flips
  in 10 frames = oscillation).
- Exclude frames where the player reverses direction (intentional).

**No extreme jumps:**
- `|delta_x|` should never exceed the camera's max scroll speed (16 px/frame) + margin.
- `|delta_y|` should never exceed a reasonable vertical tracking speed.

**Bounds clamping:**
- `camera.x >= 0` always.
- `camera.x + screen_width <= level_width` always.
- Same for Y axis.

**Player visibility:**
- Player should always be on-screen: `camera.x <= player.x <= camera.x + screen_width`.
- Allow brief exceptions during death or pipe travel.

### Location

`tests/test_camera_stability.py` â€” new file.

## Acceptance Criteria

- [ ] Camera tracks player through hold_right on all 3 stages without oscillation
- [ ] Camera tracks player through spindash_right without oscillation
- [ ] No single-frame camera delta exceeds max scroll speed + margin
- [ ] Camera never exceeds level bounds
- [ ] Player always visible on screen (with documented exceptions)
- [ ] Oscillation detection: sign-flip counting within sliding window
- [ ] `uv run pytest tests/test_camera_stability.py -x` passes
