---
id: T-004-03
story: S-004
title: game-state-machine
type: task
status: open
priority: high
phase: done
depends_on: [T-004-01, T-004-02, T-002-03, T-002-04, T-003-04]
---

## Context

Implement the top-level game state machine that connects all systems into a playable game: title screen, stage select, gameplay, results, and game over.

Reference: docs/specification.md sections 1 (game state machine), 8 (lives/game over)

## Acceptance Criteria

- [ ] `main.py` implements game state machine:
  - **TITLE:** Display game title, "Press Start" prompt. Menu music (track 0). Any button → STAGE_SELECT.
  - **STAGE_SELECT:** Show 3 stage options. Arrow keys to select, confirm to start. Initially only Stage 1 unlocked; completing a stage unlocks the next.
  - **GAMEPLAY:** Active gameplay state. Loads selected stage, runs physics/collision/rendering/audio. Pauses on ESC (Pyxel default quit can be rebound).
  - **RESULTS:** After goal post reached. Show time, ring count, score. Stage clear music (track 5). Auto-advance to STAGE_SELECT after a few seconds.
  - **GAME_OVER:** After losing all lives. Game over music (track 6). "Continue?" prompt or return to TITLE.
- [ ] Lives system: start with 3, death → respawn from checkpoint (or stage start), 0 lives → GAME_OVER
- [ ] Stage progression: completing stage N unlocks stage N+1 in select screen
- [ ] Music transitions: each state change triggers appropriate music start/stop
- [ ] Clean state reset: starting a stage resets player position, rings, timer; restarting after death preserves ring count from checkpoint
