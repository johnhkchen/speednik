---
id: T-009-05
story: S-009
title: boundary-escape-detection
type: task
status: open
priority: high
phase: done
depends_on: [T-009-02]
---

## Context

The player can walk, roll, or fall off the edge of the map and keep going forever. There is
no kill plane — the camera clamps to level boundaries (`camera.py:164-169`) but the player
has zero boundary enforcement (`player.py` has no position clamping at all). The player
sails past the edge while the camera stops following, leaving them in an invisible void with
no way to die or recover. This is a soft-lock.

This has already been hit manually ("I've run off the edge a few times").

### Two deliverables

**1. Bot-driven boundary escape tests (headless, in `tests/test_levels.py`)**

Run strategies on each real stage and assert the player never leaves the level bounds.
This catches the bug in CI without needing a human to wander off the edge.

```python
def test_hillside_player_stays_in_bounds():
    """No strategy should send the player outside level boundaries."""
    stage = load_stage("hillside")
    w, h = stage.level_width, stage.level_height
    for name, strat in STRATEGIES.items():
        result = run_on_stage("hillside", strat, frames=3600)
        for snap in result.snapshots:
            assert 0 <= snap.x <= w, (
                f"{name}: player escaped horizontally at frame {snap.frame}, "
                f"x={snap.x}, level_width={w}"
            )
            assert snap.y <= h + 64, (  # small grace for jump arcs below ground
                f"{name}: player fell off bottom at frame {snap.frame}, "
                f"y={snap.y}, level_height={h}"
            )
```

Run this for all stages. The tests will likely fail immediately — that's the point. They
document the bug and provide the regression gate for the fix.

Also test specific escape vectors:

- **Right edge**: `hold_right` for enough frames to reach the level boundary and keep going.
  On hillside the goal is near the right edge, so a bot that passes the goal could run off.
- **Left edge**: `hold_left` from spawn — can the player walk backwards off the start?
- **Bottom edge**: Place the player on a platform edge, walk off, fall. Does Y grow without
  bound? On stages with gaps or pits, the player should die (bottomless pit) not float.
- **Top edge**: Unlikely in normal play, but springs or spindash up steep ramps could
  launch the player above the level.

**2. Dev park "BOUNDARY PATROL" stage (visual, in `speednik/devpark.py`)**

A dev park stage that runs `hold_right` (and `hold_left`) on each real stage and visually
shows where the player escapes. The camera zooms out or pans to show the level edge and the
player sailing past it. A red line marks the level boundary so the developer sees the exact
moment of escape.

```
  LEVEL EDGE          PLAYER
      |                 →
      | ← boundary      •→  (escaped!)
      |
```

The stage also shows a `hold_left` bot running backwards from spawn — does it fall off the
left edge?

### Boundary rendering

When in dev park or when DEBUG is active, optionally render the level boundaries as colored
lines:

- Left edge: vertical line at x=0
- Right edge: vertical line at x=level_width
- Bottom edge: horizontal line at y=level_height
- Top edge: horizontal line at y=0

These render in world space (affected by camera) so they're visible when the camera is
near an edge. Use a bright color (red or magenta) that stands out against terrain.

### What this ticket does NOT do

This ticket **detects and visualizes** the boundary escape problem. It does NOT fix it.
The actual fix (kill plane, position clamping, or bottomless pit death trigger) should be
its own ticket — possibly under a new story or appended to this one — because the fix
involves gameplay design decisions (should the player die? respawn? hit an invisible wall?).

However, the tests from this ticket become the regression gate: once the fix lands, these
tests should pass.

### Location

- `tests/test_levels.py` — boundary escape test functions (alongside T-008-04's soft-lock
  tests)
- `speednik/devpark.py` — BOUNDARY PATROL stage entry

## Acceptance Criteria

- [ ] Boundary escape test for each real stage: player X stays within `[0, level_width]`
- [ ] Boundary escape test for each real stage: player Y stays within reasonable range
  (above level top with grace, below level bottom triggers death or stays bounded)
- [ ] Tests cover right-edge, left-edge, and bottom-edge escape vectors
- [ ] Test failure messages include strategy name, frame number, and position
- [ ] Tests marked `@pytest.mark.xfail` with a note that no kill plane exists yet —
  they document the known defect
- [ ] Dev park BOUNDARY PATROL stage shows bots approaching level edges
- [ ] Level boundary lines rendered visually (red/magenta) in dev park
- [ ] Dev park stage shows both hold_right (right edge) and hold_left (left edge) bots
- [ ] No Pyxel imports in test files
- [ ] `uv run pytest tests/ -x` passes (with expected xfails)
