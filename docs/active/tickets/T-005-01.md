---
id: T-005-01
story: S-005
title: mp3-music-playback
type: task
status: open
priority: high
phase: done
depends_on: []
---

## Context

The four stage music tracks (title, hillside, pipeworks, skybridge) have professionally composed MP3 files in assets/. The chiptune versions served as placeholders. Replace `pyxel.playm()` with `subprocess.Popen(['afplay', path])` for these four tracks so the game plays the real music. Keep chiptune playback for boss, clear, and gameover tracks which have no MP3 equivalents.

## Changes

In `speednik/audio.py`:

1. Add `import subprocess`, `import threading`, `import os` at top.
2. Define MP3 path mapping:
   - `MUSIC_TITLE` → `assets/MAIN_MENU_Genesis_of_Glory.mp3`
   - `MUSIC_HILLSIDE` → `assets/LV1_Pixel_Pursuit.mp3`
   - `MUSIC_PIPEWORKS` → `assets/LV2_Chrome_Citadel.mp3`
   - `MUSIC_SKYBRIDGE` → `assets/LV3_Genesis_Gauntlet.mp3`
3. In `play_music()`: if track_id has an MP3 mapping, kill any existing afplay subprocess, then launch `subprocess.Popen(['afplay', path])`. For looping tracks, use a threading loop that re-launches afplay when the process exits. For non-MP3 tracks, fall back to existing `pyxel.playm()`.
4. In `stop_music()`: kill any active afplay subprocess and stop the looping thread.
5. In `play_sfx()`: skip percussion ducking (`pyxel.stop(CH_PERCUSSION)`) when an MP3 track is active (percussion channel isn't being used by pyxel in that case).
6. In `update_audio()`: skip percussion resume logic when an MP3 track is active.

## Acceptance Criteria

- [ ] `play_music(MUSIC_TITLE)` launches afplay with `assets/MAIN_MENU_Genesis_of_Glory.mp3`
- [ ] `play_music(MUSIC_HILLSIDE)` launches afplay with `assets/LV1_Pixel_Pursuit.mp3`
- [ ] `play_music(MUSIC_PIPEWORKS)` launches afplay with `assets/LV2_Chrome_Citadel.mp3`
- [ ] `play_music(MUSIC_SKYBRIDGE)` launches afplay with `assets/LV3_Genesis_Gauntlet.mp3`
- [ ] Looping tracks restart automatically when afplay exits (via threading loop)
- [ ] `play_music(MUSIC_BOSS)` still uses `pyxel.playm()` (chiptune)
- [ ] `play_music(MUSIC_CLEAR)` still uses `pyxel.playm()` (chiptune)
- [ ] `play_music(MUSIC_GAMEOVER)` still uses `pyxel.playm()` (chiptune)
- [ ] `stop_music()` kills afplay subprocess and stops looping thread
- [ ] Switching tracks kills the previous afplay before starting the new one
- [ ] Percussion ducking in `play_sfx()` is skipped when afplay is active
- [ ] Percussion resume in `update_audio()` is skipped when afplay is active
- [ ] No zombie afplay processes on game exit
