---
id: T-006-01
story: S-006
title: fix-loop-arc-rasterization
type: bug
status: open
priority: high
phase: done
depends_on: []
---

## Context

The loop rasterizer in `tools/svg2stage.py` (`_rasterize_loop`) uses `round()` to convert
arc sample positions to tile height values. Python's `round()` applies banker's rounding:
values exactly at 0.5 round to the nearest even integer. For arc samples that land within
~0.5px of a tile boundary, this produces `height = 0` in the current tile, leaving no solid
surface there. The physics engine's sensor extension logic handles these at runtime (it
checks the tile below when height==0), so the loop is traversable — but the validator flags
every such case as an "Impassable gap", and there are real edge-case physics positions where
a slow-moving player could fall through a sub-pixel gap.

The fix is one line: replace `round()` with `math.ceil()` in the height calculation.
`ceil()` ensures that an arc point within a tile always registers as ≥1px of solid,
so the surface is always represented in the tile it physically occupies.

Root cause confirmed analytically: the loop in Hillside Rush (cx=3600, cy=508, r=128)
at its left/right sides (x≈3472–3488) has the arc changing ~60px vertically over 16px
horizontally. Sample points near tile row boundaries (e.g., y≈463.5 for the tile ending
at y=464) get `round(0.5) = 0` due to banker's rounding, producing spurious gaps.

The `_rasterize_line_segment` function has the same `round()` call. For regular terrain
this is masked by `_fill_interior` (which fills solid below any surface tile), but fix
it for consistency and correctness on TOP_ONLY and future surface types.

After patching, regenerate the hillside stage data and confirm the validation report
shows zero impassable-gap errors on the loop sides (columns 217–232).

## Acceptance Criteria

- [ ] In `tools/svg2stage.py`, `_rasterize_loop`: height calculation uses `math.ceil`
  instead of `round` (`height = max(0, min(16, math.ceil(tile_bottom_y - sy)))`)
- [ ] In `tools/svg2stage.py`, `_rasterize_line_segment`: same `round` → `math.ceil` change
- [ ] `uv run python tools/svg2stage.py stages/hillside_rush.svg speednik/stages/hillside/`
  runs successfully
- [ ] `speednik/stages/hillside/validation_report.txt` shows zero "Impassable gap" errors
  for loop-side columns (217–232)
- [ ] `uv run pytest tests/test_svg2stage.py -x` passes
- [ ] No regression in angle-consistency errors (count should be same or fewer)
