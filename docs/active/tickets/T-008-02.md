---
id: T-008-02
story: S-008
title: synthetic-tile-grid-builders
type: task
status: open
priority: high
phase: done
depends_on: []
---

## Context

Build helper functions that programmatically generate tile grids for elemental tests. Each
builder returns a `TileLookup` (callable `(tx, ty) -> Tile | None`) that the scenario runner
can use directly. No Pyxel imports. No stage files on disk.

The builders must produce geometrically correct tiles — proper height arrays, angles, and
solidity — because the physics engine's sensors read these values exactly. The existing
`test_terrain.py` helpers (`flat_tile()`, `slope_45_tile()`) cover single tiles; these
builders create multi-tile structures.

### Builders

**`build_flat(width_tiles, ground_row)`**

Flat ground spanning `width_tiles` columns at grid row `ground_row`. All tiles are
`height_array=[16]*16, angle=0, solidity=FULL`. Fill tiles below `ground_row` to grid bottom
(avoids sensor fall-through). Returns `TileLookup`.

This is the simplest scenario: a flat runway. Used as the baseline for every other test.

**`build_ramp(approach_tiles, ramp_tiles, start_angle, end_angle, ground_row)`**

Flat approach of `approach_tiles`, then a ramp of `ramp_tiles` that transitions from
`start_angle` to `end_angle` (byte angles). Each ramp tile gets a linearly interpolated
angle and a height array computed from `tan(angle)` slope. Ground fill below.

Used for: walkability threshold tests, speed gate tests.

**`build_loop(approach_tiles, radius, ground_row, ramp_radius=None)`**

Flat approach, then a full 360° loop circle of the given pixel `radius`, then flat exit.
If `ramp_radius` is given, includes entry/exit quarter-circle ramps (matching the geometry
from T-007-01). Loop tiles get correct arc angles, `TOP_ONLY` solidity on the upper arc,
`FULL` on the lower arc. Interior is hollow. Ground fill below the loop.

This reuses the same analytical arc math from `profile2stage.py:_rasterize_loop` and the
ramp generation from T-007-01. Import or duplicate the computation — don't hand-code 50+
tiles.

Used for: loop traversal envelope tests.

**`build_gap(approach_tiles, gap_tiles, landing_tiles, ground_row)`**

Flat approach, gap of `gap_tiles` (no tiles), flat landing. Ground fill below approach and
landing but not the gap.

Used for: gap clearing tests.

**`build_slope(approach_tiles, slope_tiles, angle, ground_row)`**

Flat approach, then a constant-angle slope of `slope_tiles`. Angle determines the rise per
pixel column. Height arrays computed from slope geometry.

Used for: adhesion tests, slip detection tests.

### Implementation approach

Each builder constructs a `dict[tuple[int, int], Tile]` and wraps it in a lookup closure:

```python
def build_flat(width_tiles, ground_row):
    tiles = {}
    for tx in range(width_tiles):
        tiles[(tx, ground_row)] = Tile(
            height_array=[16]*16, angle=0, solidity=FULL
        )
        # Fill below
        for ty in range(ground_row + 1, ground_row + 4):
            tiles[(tx, ty)] = Tile(
                height_array=[16]*16, angle=0, solidity=FULL
            )
    return lambda tx, ty: tiles.get((tx, ty))
```

For the loop builder, either import `_rasterize_loop` internals from profile2stage or
reimplement the circle math inline. The latter is preferable — test helpers shouldn't depend
on the code they're validating.

### Location

`tests/grids.py` — imported by test files, not a test file itself.

## Acceptance Criteria

- [ ] `build_flat` returns a TileLookup with flat ground + fill below
- [ ] `build_ramp` returns a TileLookup with flat approach + angle-interpolated ramp
- [ ] `build_loop` returns a TileLookup with flat approach + full 360° loop + flat exit
- [ ] `build_loop` with `ramp_radius` includes entry/exit transition arcs
- [ ] `build_gap` returns a TileLookup with approach + gap + landing
- [ ] `build_slope` returns a TileLookup with approach + constant-angle slope
- [ ] All builders produce tiles with correct height arrays for their geometry
- [ ] All builders include ground fill below the surface (prevents sensor fall-through)
- [ ] No Pyxel imports
- [ ] Loop builder: upper arc tiles have `solidity=TOP_ONLY`, lower arc `solidity=FULL`
- [ ] Loop builder: interior tiles are absent (hollow)
- [ ] Self-tests: each builder's output passes basic sanity checks (correct tile count,
  expected angle range, no None tiles in the surface layer)
- [ ] `uv run pytest tests/ -x` passes
