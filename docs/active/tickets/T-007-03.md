---
id: T-007-03
story: S-007
title: profile2stage-loop-entry-exit-ramps
type: task
status: open
priority: high
phase: done
depends_on: []
---

## Context

The `_rasterize_loop` function in `tools/profile2stage.py` (lines 627-672) has the same
bare-circle problem as `svg2stage.py`: it generates the loop circle tiles but no transition
ramps. T-006-03's acceptance criteria mentioned transition arcs but they were not implemented
in the current `_rasterize_loop` method.

This ticket adds the same quarter-circle transition arc logic described in T-007-01, applied
to the profile pipeline. Since profile2stage uses a cursor-based model, the ramp generation
integrates naturally: the ramp is generated before the loop circle, advancing the cursor
through the ramp, then the loop, then the exit ramp.

### Cursor integration

Current behavior:
- Loop starts at `cursor_x`, circle center at `(cursor_x + radius, cursor_y - radius)`
- Cursor advances by `2 * radius`

New behavior:
- Entry ramp starts at `cursor_x`, spanning `r_ramp` pixels horizontally
- Loop circle starts at `cursor_x + r_ramp`
- Exit ramp follows the loop, spanning `r_ramp` pixels horizontally
- Cursor advances by `r_ramp + 2 * radius + r_ramp`

Where `r_ramp` defaults to the loop radius (configurable for future use).

### Ramp geometry

Same as T-007-01: quarter-circle arcs that transition from flat ground (angle 0°) to the
loop's tangent at the bottom-left/right points. Entry ramp angles progress from ~0° to ~64°;
exit ramp angles progress from ~192° to ~0°. Ramp tiles are `SURFACE_SOLID` with `FULL`
solidity and ground fill beneath.

### Ramp tiles vs loop tiles

Ramp tiles are regular solid ground (`SURFACE_SOLID`, type 1), not loop tiles. They don't
get `is_loop_upper` or `TOP_ONLY` solidity. They are normal terrain the player runs on to
build up angle before entering the loop proper.

## Acceptance Criteria

- [ ] `_rasterize_loop` generates entry ramp tiles before the loop circle
- [ ] `_rasterize_loop` generates exit ramp tiles after the loop circle
- [ ] Ramp tiles have angles that smoothly transition from 0° to the loop tangent angle
- [ ] Ramp tiles are `SURFACE_SOLID` with `FULL` solidity
- [ ] Cursor advances by `r_ramp + 2 * radius + r_ramp` (total horizontal extent)
- [ ] `cursor_y` and `cursor_slope` are correctly set after the exit ramp (back to flat)
- [ ] No tile gaps between ramp and loop tiles at the tangent points
- [ ] `uv run pytest tests/test_profile2stage.py -x` passes with updated/new tests:
  - Loop segment generates ramp tiles before and after the loop circle
  - Ramp tile angles progress smoothly from 0° to loop tangent
  - Cursor position accounts for ramp extents
  - No impassable gaps at ramp-to-loop junctions
