---
id: T-011-05
story: S-011
title: entity-interaction-tests
type: task
status: open
priority: high
phase: done
depends_on: [T-010-02]
---

## Context

Test game object interactions through `sim_step` on real stages. T-010-03 verified basic
parity with the old harness. This ticket tests the **full entity lifecycle** — collecting
rings, getting damaged, scattering and recollecting rings, bouncing on enemies, hitting
springs, activating checkpoints, and reaching the goal.

### Test scenarios

**Ring collection and scatter:**
- Run hold_right on hillside. Assert `RingCollectedEvent`s appear.
- After collecting rings, engineer a damage event (run into an enemy).
  Assert `DamageEvent` fires and `player.rings` drops to 0.
- Continue running — assert some scattered rings are recollected (rings_collected increases
  after damage).

**Ring death:**
- Start a run. Take damage with 0 rings. Assert `DeathEvent` fires and `sim.player_dead`
  is True.

**Spring behavior:**
- Run toward a spring on a real stage. Assert `SpringEvent` fires.
- Assert player velocity changes (y_vel becomes negative = upward).
- Assert spring cooldown prevents immediate re-trigger.

**Enemy bounce:**
- Jump onto an enemy. Assert the enemy is destroyed and player bounces upward.
- Walk into an enemy without jumping. Assert `DamageEvent` (not destroy).

**Checkpoint activation:**
- Run through a checkpoint. Assert `CheckpointEvent` fires.
- Assert checkpoint is marked as activated.

**Goal detection:**
- Run to the goal (use spindash_right with enough frames). Assert `GoalReachedEvent`
  fires and `sim.goal_reached` is True.

### Approach

Use `create_sim(stage_name)` for real stage tests. For controlled setups (e.g. "damage with
0 rings"), use `create_sim_from_lookup` with manually placed entities by modifying the
SimState's entity lists after creation.

### Location

`tests/test_entity_interactions.py` — new file.

## Acceptance Criteria

- [ ] Ring collection produces RingCollectedEvent on real stage
- [ ] Damage with rings > 0 scatters rings (DamageEvent, rings drop to 0)
- [ ] Damage with rings == 0 produces DeathEvent
- [ ] Spring collision produces SpringEvent and upward velocity
- [ ] Enemy bounce destroys enemy (player jumping onto it)
- [ ] Enemy collision while grounded produces DamageEvent
- [ ] Checkpoint activation produces CheckpointEvent
- [ ] Goal reached produces GoalReachedEvent and sets goal_reached
- [ ] `uv run pytest tests/test_entity_interactions.py -x` passes
