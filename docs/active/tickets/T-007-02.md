---
id: T-007-02
story: S-007
title: exempt-loop-tiles-from-wall-push
type: task
status: open
priority: critical
phase: done
depends_on: []
---

## Context

Even with entry/exit ramps, edge cases can cause the player's wall sensors to hit loop arc
tiles while still in quadrant 0 (e.g., high-speed entry that skips ramp tiles, or ramp-to-loop
seam misalignment). The physics engine should recognize loop tiles and exempt them from wall
push-back as a safety net.

Currently the runtime `Tile` dataclass (`speednik/terrain.py:56-79`) has three fields:
`height_array`, `angle`, and `solidity`. It has no knowledge of whether a tile is a loop tile,
a regular surface tile, or anything else. The tile type information exists in `tile_map.json`
(as the `type` field on tile cells, where type 5 = SURFACE_LOOP) but is discarded during
level loading in `speednik/level.py:_build_tiles`.

### Changes needed

**1. Add `tile_type` to the `Tile` dataclass:**

```python
@dataclass
class Tile:
    height_array: list[int]
    angle: int
    solidity: int
    tile_type: int = 0  # 0 = unknown/default, 1 = solid, 5 = loop
```

**2. Load tile type in `level.py:_build_tiles`:**

The `tile_map.json` cell format includes a `type` field (when present). Read it and pass it
to the `Tile` constructor. Default to 0 if absent for backward compatibility.

**3. Exempt loop tiles from wall push in `terrain.py:find_wall_push`:**

After the existing angle gate check (lines 663-668), add a tile-type check:

```python
if result.found:
    # Existing angle gate
    a = result.tile_angle
    if a <= WALL_ANGLE_THRESHOLD or a >= ANGLE_STEPS - WALL_ANGLE_THRESHOLD:
        return SensorResult(found=False, distance=0.0, tile_angle=0)
    # Loop tile exemption: loop surfaces should not block as walls
    if result.tile_type == SURFACE_LOOP:
        return SensorResult(found=False, distance=0.0, tile_angle=0)
```

This requires propagating `tile_type` through the sensor cast result. Add a `tile_type` field
to `SensorResult` (default 0) and set it in `_sensor_cast` when a hit is found.

### Constants

Add `SURFACE_LOOP = 5` to the constants or terrain module, matching the value used in both
`svg2stage.py` and `profile2stage.py`.

## Acceptance Criteria

- [ ] `Tile` dataclass has a `tile_type` field (int, default 0)
- [ ] `_build_tiles` in `level.py` reads the `type` field from tile_map.json cells and passes
  it to `Tile(tile_type=...)`
- [ ] `SensorResult` has a `tile_type` field (int, default 0)
- [ ] `_sensor_cast` sets `tile_type` on the result when a hit is found
- [ ] `find_wall_push` skips push-back when `result.tile_type == SURFACE_LOOP`
- [ ] `SURFACE_LOOP = 5` constant is defined in the appropriate module
- [ ] Existing tests pass: `uv run pytest -x`
- [ ] New test: a loop tile at a wall-range angle (e.g., angle=64) is not treated as a wall
  by `find_wall_push`
- [ ] New test: a non-loop tile at the same angle IS treated as a wall (existing behavior
  preserved)
