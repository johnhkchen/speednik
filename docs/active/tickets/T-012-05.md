---
id: T-012-05
story: S-012
title: cross-stage-behavioral-invariants
type: task
status: open
priority: high
phase: done
depends_on: [T-012-01]
---

## Context

Behavioral tests that should hold true on **every stage**, regardless of geometry. These
are the physics and game-logic invariants that apply universally — if any of them fail on
any stage, it's a bug in the engine, not the level design.

### Your role

You are a QA auditor. These tests describe universal truths about the game. Failures here
are always bugs.

### Universal behavioral invariants

**1. Damage with rings scatters rings, doesn't kill**
- On every stage: collect some rings, then take damage (run into enemy).
- Assert: player is HURT (not DEAD), rings drop to 0, scattered rings exist.
- If player dies with rings > 0, that's a bug in the damage system.

**2. Damage without rings kills**
- On every stage: take damage with 0 rings.
- Assert: player is DEAD.
- If player survives with 0 rings, that's a bug.

**3. Invulnerability after damage**
- After taking damage, player should be invulnerable for 120 frames.
- Run into a second enemy within 120 frames — assert no second DamageEvent.
- If double-damage occurs, that's a bug.

**4. Wall recovery**
- On every stage: run into a wall (place player before known wall).
- Assert: player velocity goes to 0 but player is NOT stuck (can jump or reverse).
- If player clips into the wall or can't escape, that's a bug.

**5. Slope adhesion at low speed**
- On every stage with slopes: walk slowly onto a gentle slope (angle < 20).
- Assert: player follows the slope surface (Y changes, on_ground stays True).
- If player floats above the slope or snaps to a flat surface, that's a bug.

**6. Fall death below level bounds**
- On every stage: somehow get the player below level_height.
- Assert: player is DEAD (or at minimum, the game handles it — no infinite fall).

**7. Spindash charges and releases**
- On every stage: execute a spindash (crouch, charge 3x, release).
- Assert: ground_speed after release ≥ 8.0 (the base spindash speed).
- If spindash doesn't achieve expected speed, that's a physics bug.

**8. Camera never loses the player**
- On every stage × every archetype: camera.x tracks player within screen bounds.
- Assert: player is visible on screen at all times (within documented exceptions).

### Parameterization

```python
STAGES = ["hillside", "pipeworks", "skybridge"]

@pytest.mark.parametrize("stage", STAGES)
def test_damage_with_rings_scatters(stage):
    ...

@pytest.mark.parametrize("stage", STAGES)
def test_spindash_reaches_base_speed(stage):
    ...
```

Each invariant × each stage. Failures are always bugs — no xfail unless a known engine
issue is tracked.

### Location

`tests/test_audit_invariants.py`
Bug tickets in `docs/active/tickets/T-012-05-BUG-*.md`

## Acceptance Criteria

- [ ] 8+ invariant tests, each parameterized across all 3 stages
- [ ] Damage/ring/death mechanics verified on all stages
- [ ] Invulnerability window verified
- [ ] Wall recovery verified (player can escape after hitting a wall)
- [ ] Slope adhesion verified at low speed
- [ ] Spindash speed verified
- [ ] Camera tracking verified
- [ ] All failures are bugs (no "expected failures" in this file)
- [ ] Bug tickets for any findings
- [ ] `uv run pytest tests/test_audit_invariants.py -v` runs clean
