---
id: T-008-04
story: S-008
title: level-softlock-detection
type: task
status: open
priority: high
phase: done
depends_on: [T-008-01]
---

## Context

Run robotic player strategies against real stage data and verify that each level is
completable with the intended difficulty strategy. This is the "does the game actually work"
test that would have caught the loop bug before a human ever hit it.

### Per-level strategy requirements

Each stage has a design-intended minimum strategy. The test verifies that the intended
strategy reaches the goal and that simpler strategies fail at expected points (not at
unexpected blockages).

**Hillside (Stage 1) — beginner level**

The intended strategy is `hold_right`. A player who just holds right should be able to reach
the goal (after S-007 loop ramps are in place). Spindash is not required.

```python
def test_hillside_completable_hold_right():
    result = run_on_stage("hillside", hold_right, frames=3600)
    goal_x = get_goal_x("hillside")
    assert result.max_x >= goal_x, (
        f"hold_right stuck at x={result.stuck_at()}, goal at x={goal_x}"
    )
```

Note: this test will FAIL until S-007 is complete (the loop blocks hold_right). That's
correct — the test documents the known defect. Mark it `@pytest.mark.xfail` with a
reference to S-007 until the fix lands.

**Pipeworks (Stage 2) — requires jumping**

```python
def test_pipeworks_hold_right_fails():
    """Stage 2 has gaps that require jumping."""
    result = run_on_stage("pipeworks", hold_right, frames=3600)
    goal_x = get_goal_x("pipeworks")
    assert result.max_x < goal_x  # should not complete without jumping

def test_pipeworks_completable_hold_right_jump():
    result = run_on_stage("pipeworks", hold_right_jump, frames=3600)
    goal_x = get_goal_x("pipeworks")
    assert result.max_x >= goal_x
```

**Skybridge (Stage 3) — requires advanced techniques**

```python
def test_skybridge_completable_spindash():
    result = run_on_stage("skybridge", spindash_right, frames=5400)
    # Note: boss fight may block pure forward movement.
    # Assert reaching boss area rather than goal.
    boss_x = ...
    assert result.max_x >= boss_x
```

### Structural blockage detection

The most valuable check: run ALL strategies and flag any X coordinate where they ALL stall.
That's a level design defect, not a skill gate.

```python
STRATEGIES = {
    "idle": idle,
    "hold_right": hold_right,
    "hold_right_jump": hold_right_jump,
    "spindash_right": spindash_right,
}

def test_hillside_no_structural_blockage():
    """At least one strategy should reach the goal."""
    goal_x = get_goal_x("hillside")
    best_x = 0.0
    for name, strat in STRATEGIES.items():
        result = run_on_stage("hillside", strat, frames=3600)
        best_x = max(best_x, result.max_x)
    assert best_x >= goal_x, (
        f"No strategy reached goal (x={goal_x}), best was x={best_x}"
    )
```

### Progress tracking

For long-running level tests, track the player's maximum X over time to detect stalls:

```python
def test_hillside_no_stall_longer_than_3_seconds():
    """Player should not be stuck at any X for more than 180 frames."""
    result = run_on_stage("hillside", hold_right_jump, frames=3600)
    stall_x = result.stuck_at(tolerance=2.0)
    if stall_x is not None:
        # Find how long they were stuck
        frames_stuck = count_frames_at_x(result, stall_x, tolerance=2.0)
        assert frames_stuck < 180, (
            f"Player stuck at x={stall_x} for {frames_stuck} frames (3+ seconds)"
        )
```

### Helper: get_goal_x

```python
def get_goal_x(stage_name: str) -> float:
    stage = load_stage(stage_name)
    goals = [e for e in stage.entities if e.get("type") == "goal"]
    return float(goals[0]["x"])
```

### Location

`tests/test_levels.py`

## Acceptance Criteria

- [ ] Hillside: `hold_right` reaches goal (xfail until S-007 lands)
- [ ] Hillside: `spindash_right` reaches goal (should pass even before S-007 due to wall
  angle threshold, but verify)
- [ ] Hillside: structural blockage test — at least one strategy reaches goal
- [ ] Pipeworks: `hold_right` does NOT reach goal (gaps require jumping)
- [ ] Pipeworks: `hold_right_jump` reaches goal
- [ ] Skybridge: `spindash_right` reaches boss area
- [ ] No Pyxel imports
- [ ] Each test's failure message includes the stall X coordinate and strategy name
- [ ] `uv run pytest tests/test_levels.py -x` passes (with expected xfails)
