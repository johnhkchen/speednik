---
id: T-006-05
story: S-006
title: profile2stage-overlays-entities-validation
type: task
status: open
priority: medium
phase: done
depends_on: [T-006-02]
---

## Context

Complete the three-layer model in `profile2stage.py` by adding overlays (platforms, springs),
the entities layer, and the full pre-rasterization validation pass.

### Schema additions

Full profile JSON schema after this ticket:

```json
{
  "width": 4800,
  "height": 720,
  "start_y": 636,
  "track": [...],
  "overlays": [
    {"type": "platform", "at": "hills", "offset_x": 300, "y_offset": -100, "width": 160, "one_sided": true},
    {"type": "spring_up", "at": "pre_loop", "offset_x": -20, "y_offset": 0},
    {"type": "spring_right", "at": "landing", "offset_x": 10, "y_offset": 0}
  ],
  "entities": [
    {"type": "player_start", "at": "opening", "offset_x": 64},
    {"type": "ring_line", "at": "hills", "offset_x": 100, "count": 10, "spacing": 24, "y_offset": -30},
    {"type": "enemy", "at": "finale", "offset_x": 50, "subtype": "motobug"},
    {"type": "checkpoint", "at": "mid", "offset_x": 0},
    {"type": "goal", "at": "finale", "offset_x": 200}
  ]
}
```

### Overlay types

**platform:** A horizontal one-sided or solid platform.
- `at`: segment ID anchor. The platform starts at `segment_start_x + offset_x`.
- `offset_x`: horizontal offset from segment start in pixels (may be negative to reach into previous segment)
- `y_offset`: vertical offset from segment surface at `at+offset_x`. Negative = above ground.
- `width`: platform width in pixels
- `one_sided`: if true, solidity = `TOP_ONLY`; if false, solidity = `FULL`
- Rasterized as a flat strip of tiles with height_array=[16]*16 across `width` pixels

**spring_up / spring_right:** Entity placement only (spring physics handled by the game
engine's entity system). These become entries in `entities.json` with type `spring_up` /
`spring_right` at the resolved world position.

### Entity anchoring

All entity and overlay positions use the same reference frame:
- `at`: segment ID. Resolves to `segment_start_x` as the base x, and `segment_surface_y_at_offset_x`
  as the base y (ground surface height at the point `segment_start_x + offset_x`).
- `offset_x`: added to `segment_start_x` → `world_x = segment_start_x + offset_x`
- `y_offset`: added to the ground surface y at `world_x` → `world_y = surface_y + y_offset`
  (negative y_offset = above ground, since y increases downward)

**Homing chain reference frame (deferred — spec only):**
Not implemented in this ticket, but the spec is codified here for future implementation:
- First target: `y_offset` relative to ground surface at anchor x
- Subsequent targets: `dx`/`dy` deltas relative to the previous target
- Validation: each hop distance checked against max homing lock-on range (constant TBD)

### ring_line entity

`ring_line` is a shorthand that expands to N individual `ring` entities:
```json
{"type": "ring_line", "at": "hills", "offset_x": 100, "count": 10, "spacing": 24, "y_offset": -30}
```
Expands to 10 rings at x = base_x + 0, base_x + 24, ..., base_x + 216, all at y = surface_y - 30.

### Enemy entity

```json
{"type": "enemy", "at": "seg_id", "offset_x": 50, "subtype": "motobug"}
```
`subtype` maps to: `motobug` → `enemy_crab`, `buzzbomber` → `enemy_buzzer`,
`chopper` → `enemy_chopper`. The mapped type is written to `entities.json`.

### Pre-rasterization validation

Runs before any rasterization. Errors abort synthesis; warnings are collected and
included in `validation_report.txt` as `WARNING:` prefix lines above the post-raster
Validator output.

Checks:
1. **Slope limit:** `abs(rise/len) > 1.0` → error: "ramp {id}: slope {val:.2f} exceeds maximum passable ratio 1.0"
2. **Slope warning:** `abs(rise/len) > tan(30°)` → warning: "ramp {id}: steep slope {val:.2f}, may be difficult to traverse"
3. **Loop radius:** `radius < 32` → error; `radius < 64` → warning
4. **Wave floor clamp:** `cursor_y + amplitude > height - TILE_SIZE` → warning per affected dx
5. **Halfpipe depth:** `cursor_y + depth >= height - TILE_SIZE` → error
6. **Entity segment reference:** `at` field references nonexistent segment ID → error
7. **Entity offset bounds:** `offset_x` places entity outside its referenced segment's x range → warning (not error, allows reaching adjacent segments)
8. **Duplicate segment IDs:** error if two segments share the same explicit `id`
9. **player_start:** warning if no `player_start` entity defined (meta.json will have `null`)

### Output

`meta.json.player_start` is populated from the `player_start` entity's resolved world position.
`entities.json` contains all expanded entities (ring_line expanded, enemies mapped to subtypes).
`validation_report.txt` format: pre-raster warnings first, then post-raster Validator output.

## Acceptance Criteria

- [ ] `platform` overlay type rasterized as TOP_ONLY or FULL tiles at resolved world position
- [ ] `spring_up` and `spring_right` overlays emitted as entities in `entities.json`
- [ ] All entity types resolve world position via `at` + `offset_x` + `y_offset`
- [ ] `ring_line` expands to N ring entities with correct x spacing and y position
- [ ] `enemy` subtypes map correctly: `motobug→enemy_crab`, `buzzbomber→enemy_buzzer`, `chopper→enemy_chopper`
- [ ] `player_start` entity populates `meta.json.player_start`
- [ ] `checkpoint` and `goal` entities emitted verbatim to `entities.json`
- [ ] All 9 pre-rasterization validation checks implemented
- [ ] Errors abort synthesis (exit non-zero); warnings are collected and continue
- [ ] `validation_report.txt` shows pre-raster warnings before post-raster Validator output
- [ ] `uv run pytest tests/test_profile2stage.py -x` passes with new overlay/entity tests:
  - `platform` overlay produces TOP_ONLY tiles at correct world position
  - `ring_line` of N=5 expands to 5 ring entities at correct positions
  - Enemy subtype mapping is correct
  - `player_start` entity sets `meta.json.player_start`
  - Missing segment ID in `at` field raises an error
  - Duplicate segment ID raises an error
  - Slope-too-steep error raises and aborts synthesis
