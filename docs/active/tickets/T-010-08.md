---
id: T-010-08
story: S-010
title: env-registration-and-validation
type: task
status: open
priority: high
phase: research
depends_on: [T-010-07]
---

## Context

Register the Speednik environments with Gymnasium and validate them with `check_env`.
This is the "it actually works as a gym env" gate.

See `docs/specs/scenario-testing-system.md` §3.4 for registration.

### Environment registration

```python
# speednik/env_registration.py

import gymnasium as gym

gym.register(
    id="speednik/Hillside-v0",
    entry_point="speednik.env:SpeednikEnv",
    kwargs={"stage": "hillside"},
    max_episode_steps=3600,
)

gym.register(
    id="speednik/Pipeworks-v0",
    entry_point="speednik.env:SpeednikEnv",
    kwargs={"stage": "pipeworks"},
    max_episode_steps=5400,
)

gym.register(
    id="speednik/Skybridge-v0",
    entry_point="speednik.env:SpeednikEnv",
    kwargs={"stage": "skybridge"},
    max_episode_steps=7200,
)
```

Import this module to trigger registration. CleanRL and the scenario runner will do
`import speednik.env_registration` at the top.

### check_env validation

Gymnasium provides `gymnasium.utils.env_checker.check_env()` which validates:
- observation_space and action_space are properly defined
- reset() returns (obs, info) with correct types
- step() returns (obs, reward, terminated, truncated, info) with correct types
- obs is within observation_space bounds
- action sampling works

```python
def test_check_env_hillside():
    import speednik.env_registration
    env = gym.make("speednik/Hillside-v0")
    check_env(env.unwrapped)
```

### Manual loop test

Run 100 steps with random actions to verify stability:

```python
def test_random_actions_100_steps():
    env = SpeednikEnv(stage="hillside")
    obs, info = env.reset()
    for _ in range(100):
        action = env.action_space.sample()
        obs, reward, terminated, truncated, info = env.step(action)
        assert obs.shape == (OBS_DIM,)
        assert isinstance(reward, float)
        if terminated or truncated:
            obs, info = env.reset()
```

### Dependency

`gymnasium` must be added as a dependency. Use `uv add gymnasium`.

### Location

- `speednik/env_registration.py` — new file
- `tests/test_env.py` — new file for env validation tests

## Acceptance Criteria

- [ ] `gymnasium` added as a project dependency
- [ ] Three environments registered: Hillside-v0, Pipeworks-v0, Skybridge-v0
- [ ] `gym.make("speednik/Hillside-v0")` creates a working environment
- [ ] `check_env` passes for Hillside-v0
- [ ] `check_env` passes for Pipeworks-v0
- [ ] `check_env` passes for Skybridge-v0
- [ ] 100-step random action loop completes without errors
- [ ] Reset after termination works correctly
- [ ] Observations are finite (no NaN/Inf) during random play
- [ ] No Pyxel imports in env.py or env_registration.py
- [ ] `uv run pytest tests/test_env.py -x` passes
