---
id: T-012-07
story: S-012
title: svg2stage-angle-fix-and-regenerate
type: bug
status: open
priority: critical
phase: done
depends_on: [T-012-02, T-012-03]
---

## Context

The hillside and pipeworks behavior audits (T-012-02, T-012-03) independently surfaced the
same root cause: `tools/svg2stage.py` produces angle=64 (wall quadrant) tiles on terrain
that should be gently sloped or flat. This blocks 9 of 12 archetype tests across the two
stages.

### Evidence

**Hillside (T-012-02-BUG-01):** Tile (37,38) has angle=64 where neighbors have angle=0
and angle=2. Single tile, blocks Walker/Cautious/Wall Hugger at x=601.

**Pipeworks (T-012-03-BUG-01):** Tile column tx=32, rows 10-15 all have angle=64 with
solidity=2 (FULL). Six consecutive wall tiles atop a slope approach. Blocks Jumper, Speed
Demon, Cautious, Chaos before x=520.

Same pattern: the pipeline assigns wall angles to surface tiles that should be walkable
ground.

### Root cause analysis

`_compute_segment_angle(p1, p2)` in svg2stage.py computes byte angles from SVG line
segment direction using `atan2(dy, dx)`. The function is mathematically correct, but
problems arise in two scenarios:

1. **Short/degenerate segments**: Near-zero-length segments or segments with large dy
   relative to dx produce steep angles (64 = 90° = pure wall). These get assigned to
   tiles that are geometrically part of a walkable surface.

2. **Rasterization boundary effects**: When a polygon edge crosses a tile boundary at a
   steep local angle (even if the overall surface is gentle), the per-tile angle reflects
   the local edge direction, not the surface normal. A jagged SVG polygon edge can produce
   isolated wall angles on otherwise flat ground.

### Existing validation gap

`_check_accidental_walls` scans for runs of steep tiles longer than `MAX_STEEP_RUN`. This
catches columns of walls but misses:
- Single isolated wall tiles (hillside BUG-01 is one tile)
- Short runs that are still impassable (pipeworks BUG-01 is 6 tiles, may be under threshold)

### Fix approach

**1. Angle smoothing in the rasterizer**

After all tiles are rasterized, run a post-processing pass that detects isolated steep
tiles (angle in wall quadrant, byte angle 33-96 or 160-224) surrounded by non-steep
neighbors. Replace the outlier angle with the average of its walkable neighbors.

```python
def _smooth_accidental_walls(grid):
    """Post-process: replace isolated wall-angle tiles with neighbor average."""
    for ty in range(grid.rows):
        for tx in range(grid.cols):
            tile = grid.get_tile(tx, ty)
            if tile is None or tile.is_loop_upper:
                continue
            if not _is_steep(tile.angle):
                continue
            # Check neighbors
            neighbors = []
            for dtx in [-1, 1]:
                n = grid.get_tile(tx + dtx, ty)
                if n is not None and not _is_steep(n.angle):
                    neighbors.append(n.angle)
            if len(neighbors) >= 1:
                # Isolated steep tile — replace with neighbor average
                tile.angle = round(sum(neighbors) / len(neighbors)) % 256
```

This is conservative: it only fixes tiles where at least one horizontal neighbor is
non-steep. Legitimate wall tiles (actual vertical surfaces) have steep neighbors and won't
be touched. Loop tiles are excluded via `is_loop_upper`.

**2. Strengthen the validator**

Extend `_check_accidental_walls` to also flag isolated steep tiles (run length 1) when
surrounded by non-steep neighbors. Change from warning to auto-fix in the smoothing pass.

**3. Regenerate all 3 stages**

```bash
uv run python tools/svg2stage.py stages/hillside_rush.svg speednik/stages/hillside/
uv run python tools/svg2stage.py stages/pipe_works.svg speednik/stages/pipeworks/
uv run python tools/svg2stage.py stages/skybridge_gauntlet.svg speednik/stages/skybridge/
```

**4. Re-run audits and verify xfails flip**

```bash
uv run pytest tests/test_audit_hillside.py tests/test_audit_pipeworks.py -v
```

Expected: xfails referencing BUG-01 (wall angles) should now XPASS, which means we
remove the xfail markers and let them pass clean. Boundary clamp bugs (BUG-02, BUG-03)
are separate issues and will remain xfailed.

### Scope

This ticket fixes the **pipeline** (svg2stage.py) and **regenerates stage data**. It does
NOT fix:
- Boundary clamping (T-012-02-BUG-02, T-012-02-BUG-03) — separate physics fix
- Solid tile clipping (T-012-03-BUG-02) — separate collision resolution fix
- profile2stage angle issues (if any) — separate ticket if needed

### Location

Modified: `tools/svg2stage.py` (add smoothing pass + strengthen validator)
Regenerated: `speednik/stages/hillside/`, `speednik/stages/pipeworks/`,
`speednik/stages/skybridge/`
Modified: `tests/test_audit_hillside.py`, `tests/test_audit_pipeworks.py` (remove BUG-01
xfail markers if fixed)

## Acceptance Criteria

- [ ] Angle smoothing pass added to svg2stage.py
- [ ] Smoothing only affects isolated steep tiles with non-steep neighbors
- [ ] Loop tiles excluded from smoothing
- [ ] Validator detects isolated steep tiles (not just long runs)
- [ ] All 3 stages regenerated with the fixed pipeline
- [ ] Hillside tile (37,38) no longer has angle=64
- [ ] Pipeworks tile column tx=32 no longer has angle=64 on walkable surface
- [ ] `test_hillside_walker` passes (remove xfail if fixed)
- [ ] `test_pipeworks_jumper` and `test_pipeworks_speed_demon` pass (remove xfails if fixed)
- [ ] No new test failures introduced by regeneration
- [ ] `uv run pytest tests/ -x` passes
