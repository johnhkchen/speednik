---
id: T-011-06
story: S-011
title: naive-player-regression-suite
type: task
status: open
priority: high
phase: done
depends_on: [T-011-01, T-011-02, T-011-03, T-011-04, T-011-05]
---

## Context

The umbrella regression suite. Combines the walkthrough tests, invariant checker, geometric
probes, camera stability, and entity interaction tests into a single parameterized test
matrix that runs for every (stage, strategy) pair. This is the "if anything regresses, this
test file catches it" gate.

### Test matrix

3 stages × 3 strategies = 9 combinations. For each:

1. Run `sim_step` for N frames (enough to reach goal or hit frame budget).
2. Record per-frame snapshots (position, velocity, angle, quadrant, state).
3. Record per-frame events from `sim_step`.
4. Run camera alongside, record camera positions.
5. Run `check_invariants` on the trajectory → assert 0 error-severity violations.
6. Run camera oscillation check → assert no wobble.
7. Assert forward progress (max_x exceeds threshold).
8. Log results summary: final X, rings collected, deaths, goal reached, frame count.

### Regression baseline

On first run, the test logs a results summary per combination. Future runs compare against
expected thresholds (not exact values — physics changes may shift numbers). The thresholds
are:
- `max_x >= X_THRESHOLD[stage]` (at least 50% of level width)
- `deaths <= MAX_DEATHS[stage][strategy]`
- `invariant_errors == 0`
- `camera_oscillations == 0`

### Parameterization

```python
STAGES = ["hillside", "pipeworks", "skybridge"]
STRATEGIES = [
    ("hold_right", hold_right),
    ("hold_right_jump", hold_right_jump),
    ("spindash_right", spindash_right),
]

@pytest.mark.parametrize("stage", STAGES)
@pytest.mark.parametrize("strategy_name,strategy_fn", STRATEGIES)
def test_regression(stage, strategy_name, strategy_fn):
    ...
```

### Location

`tests/test_regression.py` — new file. Imports from `test_walkthrough`, `test_invariants`,
`test_camera_stability`, etc. as needed, or reimplements the checks inline.

## Acceptance Criteria

- [ ] 9 parameterized test cases (3 stages × 3 strategies)
- [ ] Each test runs sim_step + camera for full frame budget
- [ ] Each test runs invariant checker → 0 error violations
- [ ] Each test checks camera stability → no oscillation
- [ ] Each test asserts forward progress threshold
- [ ] Each test asserts death count within bounds
- [ ] Results logged per combination (for future comparison)
- [ ] `uv run pytest tests/test_regression.py -x` passes
