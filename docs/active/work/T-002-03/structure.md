# Structure — T-002-03: Stage 2 Pipe Works SVG Layout

## 1. Files Created

### `stages/pipe_works.svg`
The SVG layout file — primary deliverable. ~400–500 lines.

**ViewBox:** `0 0 5600 1024`

**Terrain polygons (~20):**

| ID/Comment | Type | Stroke | Section | Route | Description |
|---|---|---|---|---|---|
| S1 entry floor | polygon | #00AA00 | 1 | all | Main mid-level platform y=520, x=100–800. Closes to y=1024. |
| S1 low floor | polygon | #00AA00 | 1 | low | Floor at y=900, x=0–800. Closes to y=1024. |
| S1 high ramp | polygon | #FF8800 | 1 | — | 45° slope x=200–520, y=520→200. Launch slope. |
| S1 high ceiling | polygon | #00AA00 | 1 | high | Flat surface at y=160, x=520–800. Closes to y=256. |
| S2 high surface | polygon | #00AA00 | 2 | high | Flat y=160, x=800–2800. Closes to y=256. |
| S2 high dropdown 1 | polygon | #0000FF | 2 | high | Top-only at y=256, x=1580–1620. |
| S2 high dropdown 2 | polygon | #0000FF | 2 | high | Top-only at y=256, x=2180–2220. |
| S2 mid plat 1 | polygon | #00AA00 | 2 | mid | Platform y=520, x=800–1180. Closes to y=640. |
| S2 mid plat 2 | polygon | #00AA00 | 2 | mid | Platform y=520, x=1320–1680. Closes to y=640. |
| S2 mid plat 3 | polygon | #00AA00 | 2 | mid | Platform y=520, x=1820–2180. Closes to y=640. |
| S2 mid plat 4 | polygon | #00AA00 | 2 | mid | Platform y=520, x=2320–2800. Closes to y=640. |
| S2 low floor | polygon | #00AA00 | 2 | low | Floor y=900, x=800–2800. Closes to y=1024. |
| S2 low top-only 1 | polygon | #0000FF | 2 | low | Platform y=860, x=1000–1200. Over liquid. |
| S2 low top-only 2 | polygon | #0000FF | 2 | low | Platform y=860, x=1600–1800. Over liquid. |
| S2 low top-only 3 | polygon | #0000FF | 2 | low | Platform y=860, x=2200–2400. Over liquid. |
| S3 room | polygon | #00AA00 | 3 | all | Convergence room floor y=960, with step platforms. Closes to y=1024. |
| S4 downhill | polygon | #00AA00 | 4 | all | Sloped terrain y=400→800, x=3800–4800. Closes to y=1024. |
| S5 goal flat | polygon | #00AA00 | 5 | all | Flat at y=800, x=4800–5600. Closes to y=1024. |

**Entity elements (~330):**

| Type | Count | Element | Sections |
|---|---|---|---|
| player_start | 1 | `<circle>` | S1 (mid route, x=200, y=510) |
| ring | ~300 | `<circle>` | All sections |
| pipe_h | 4 | `<rect>` | S2 mid route gaps |
| checkpoint | 2 | `<circle>` | S3 entry, S5 entry |
| enemy_crab | 5 | `<rect>` | S2 low, S4 |
| enemy_buzzer | 3 | `<circle>` | S2 mid |
| enemy_chopper | 2 | `<circle>` | S3 |
| spring_up | 3 | `<rect>` | S1 (route transitions), S3 |
| spring_right | 1 | `<rect>` | S2 mid gap assist |
| liquid_trigger | 1 | `<circle>` | S3 (x=2800) |
| goal | 1 | `<rect>` | S5 |

### `speednik/stages/pipeworks/` (directory)
Pipeline output — 5 JSON files generated by `tools/svg2stage.py`:
- `tile_map.json` — 350x64 2D array
- `collision.json` — 350x64 2D array
- `entities.json` — flat array of ~330 entities
- `meta.json` — dimensions, player_start, checkpoints
- `validation_report.txt` — validation output

### `speednik/stages/pipeworks.py`
Stage loader — ~70 lines. Identical pattern to `hillside.py`:
- Imports `StageData` from hillside (or defines its own — see Module Boundaries)
- `_DATA_DIR = Path(__file__).parent / "pipeworks"`
- `load() -> StageData` function

### `tests/test_pipeworks.py`
Stage loader tests — ~150 lines. Mirrors `test_hillside.py` structure with Stage 2 specific values.

## 2. Files Modified

None. All deliverables are new files. The pipeline (`tools/svg2stage.py`) already supports all needed entity types.

## 3. Files Deleted

None.

## 4. Module Boundaries

### StageData Reuse
`hillside.py` defines `StageData` as a dataclass. `pipeworks.py` needs the same type. Two options:
- **Import from hillside:** `from speednik.stages.hillside import StageData` — creates a dependency.
- **Redefine locally:** Copy the dataclass into `pipeworks.py` — duplicates code.

Decision: **Import from hillside.** The `StageData` type is the interface contract between stages and the engine. It belongs conceptually in a shared location. Since there's no `speednik/stages/base.py` yet and refactoring is out of scope, importing from hillside is the pragmatic choice. Both stages return the same type.

### Pipeline Interface
The SVG → JSON pipeline is a standalone tool. No changes needed. The command:
```
python tools/svg2stage.py stages/pipe_works.svg speednik/stages/pipeworks/
```

### Test Independence
`test_pipeworks.py` imports only from `speednik.stages.pipeworks` (which re-exports or imports `StageData`). No cross-test dependencies.

## 5. SVG Organization

The SVG file is organized by section, with comments separating each section and sub-section:

```
<!-- SECTION 1: Entry Hall (0-800) -->
  <!-- S1 terrain polygons -->
  <!-- S1 entities -->

<!-- SECTION 2: Diverged Paths (800-2800) -->
  <!-- S2 High Route terrain -->
  <!-- S2 High Route entities (rings) -->
  <!-- S2 Mid Route terrain (4 platforms) -->
  <!-- S2 Mid Route entities (rings, pipes, buzzers) -->
  <!-- S2 Low Route terrain -->
  <!-- S2 Low Route entities (rings, crabs, choppers) -->

<!-- SECTION 3: Liquid Rise Zone (2800-3800) -->
  <!-- S3 terrain -->
  <!-- S3 entities -->

<!-- SECTION 4: Reconvergence (3800-4800) -->
  <!-- S4 terrain -->
  <!-- S4 entities -->

<!-- SECTION 5: Goal (4800-5600) -->
  <!-- S5 terrain -->
  <!-- S5 entities -->
```

## 6. Ordering

1. Create `stages/pipe_works.svg` (the design artifact)
2. Run `tools/svg2stage.py` to generate pipeline output into `speednik/stages/pipeworks/`
3. Create `speednik/stages/pipeworks.py` (the loader)
4. Create `tests/test_pipeworks.py` (the tests)
5. Run tests and validate
