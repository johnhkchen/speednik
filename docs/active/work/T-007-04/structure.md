# T-007-04 Structure: Regenerate Hillside & Verify Loop

## Overview

This ticket regenerates hillside stage data and adds an integration test. No game logic
or physics code changes. Two categories of work: pipeline execution and test creation.

---

## Files Modified

### speednik/stages/hillside/tile_map.json
- **Action:** Regenerated by running svg2stage pipeline
- **Expected change:** Should be identical or near-identical to current committed version
  (T-007-01 already regenerated). Any differences indicate a pipeline bug.

### speednik/stages/hillside/collision.json
- **Action:** Regenerated by pipeline
- **Expected change:** Same as above — should match current committed version.

### speednik/stages/hillside/entities.json
- **Action:** Regenerated by pipeline
- **Expected change:** Same as above.

### speednik/stages/hillside/meta.json
- **Action:** Regenerated by pipeline
- **Expected change:** Same as above.

### speednik/stages/hillside/validation_report.txt
- **Action:** Regenerated by pipeline
- **Expected change:** Same warnings as current version. Any new warnings indicate
  a regression; any removed warnings indicate a pipeline improvement.

---

## Files Created

### tests/test_hillside_integration.py (~150 lines)
- **Purpose:** Integration test that loads the actual hillside stage data and verifies
  loop region properties end-to-end.
- **Module boundary:** Standalone test file, imports from `speednik.level` and
  `speednik.terrain` only. Does not import from tools/.
- **Public interface:** pytest test functions, no exported API.

**Test structure:**

```
class TestHillsideLoopIntegration:
    @classmethod
    def setup_class(cls):
        # Load hillside stage via level.load_stage("hillside")
        # Store tile_lookup, meta for all tests

    def test_ramp_tiles_exist():
        # Verify non-None tiles in entry ramp columns (209-216)
        # and exit ramp columns (233-241) at ground level row

    def test_loop_tiles_exist():
        # Verify non-None tiles with tile_type == SURFACE_LOOP
        # in loop columns (217-232)

    def test_tile_type_propagation():
        # Verify Tile.tile_type == 5 for loop tiles loaded via level.py
        # This is the critical integration point between svg2stage and terrain.py

    def test_ramp_angle_progression():
        # Collect angles from entry ramp tiles, verify monotonic progression
        # Collect angles from exit ramp tiles, verify monotonic progression
        # No jumps > ANGLE_CONSISTENCY_THRESHOLD between adjacent ramp tiles

    def test_loop_upper_tiles_top_only_solidity():
        # Verify loop tiles above center have TOP_ONLY solidity (1)
        # This allows the player to enter the loop from below

    def test_loop_lower_tiles_full_solidity():
        # Verify loop tiles below center have FULL solidity (2)
        # These provide the ground surface through the loop

    def test_ground_continuity_through_loop_region():
        # For each column from entry ramp start to exit ramp end,
        # verify at least one tile provides ground (height_array not all 0)
        # at or near ground level — no column is completely empty

    def test_wall_sensor_exemption_for_loop_tiles():
        # Create a tile_lookup from loaded data
        # Cast wall sensors at a loop tile position
        # Verify wall sensors return not-found for loop tiles
        # (exercises the full terrain.find_wall_push + loop exemption)
```

---

## Files NOT Modified

- `tools/svg2stage.py` — no changes; pipeline runs as-is
- `speednik/terrain.py` — no changes; physics unchanged
- `speednik/level.py` — no changes; loading logic unchanged
- `speednik/constants.py` — no changes
- `tools/profile2stage.py` — not involved in hillside generation
- `tests/test_svg2stage.py` — existing ramp tests sufficient
- `tests/test_terrain.py` — existing wall sensor tests sufficient
- `tests/test_profile2stage.py` — not involved in hillside generation

---

## Architecture Notes

The integration test bridges two subsystems that were previously tested in isolation:

```
svg2stage (tested in test_svg2stage.py)
    ↓ writes tile_map.json with "type": 5
level.py (thin loader, tested implicitly)
    ↓ builds Tile(tile_type=5)
terrain.py (tested in test_terrain.py)
    ↓ wall sensor reads tile_type, exempts loop tiles
```

The integration test loads the *actual* hillside stage data (not mocked) through `level.py`
and inspects the resulting `Tile` objects. This verifies the full chain without needing to
run the game.

---

## Ordering

1. Regenerate hillside stage data (pipeline run)
2. Run existing test suite to confirm no regressions
3. Create integration test file
4. Run full test suite including new integration test
