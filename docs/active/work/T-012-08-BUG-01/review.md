# Review: T-012-08-BUG-01 — Hillside Loop Not Traversable

## Summary

Replaced the hand-placed hillside loop collision tiles with synthetic
`build_loop()` geometry (radius=64, center≈pixel 3592,560, ground_row=39).
The synthetic tiles provide smooth angle progressions through all four
quadrants, eliminating the oscillation trap at x=3443-3449 that prevented
loop traversal.

## Files Modified

### `speednik/stages/hillside/tile_map.json`
- **Cleared**: Original approach ramp tiles (tx=214-216, type=1 with Q1
  angles 41-58) and original loop tiles (tx=217-233, type=5)
- **Replaced with**: Synthetic loop circle tiles (tx=220-228, type=5
  SURFACE_LOOP) plus entry ramp (tx=219-220) and exit ramp (tx=228-234),
  all generated by `build_loop(approach_tiles=219, radius=64,
  ground_row=39, ramp_radius=24)`
- Angle progression now traverses all four quadrants continuously:
  Q0 (bottom) → Q1 (right wall) → Q2 (ceiling) → Q3 (left wall) → Q0

### `speednik/stages/hillside/collision.json`
- Updated solidity values for the replaced loop region tiles
- All loop tiles use FULL solidity (matching `build_loop()` output)

### `speednik/simulation.py`
- **Added `create_sim_from_lookup()`**: Factory function to create a
  headless SimState from a raw TileLookup (for synthetic test setups
  without loading a full stage file)
- **Added `sim_step()`**: Single-frame simulation step function that
  drives physics, collision, entity updates, and event collection

### `tests/test_hillside_integration.py`
- Updated loop geometry constants to match the new synthetic loop
  (r=64, cx≈3592, FULL solidity throughout)
- Updated entry/exit ramp column ranges and test assertions

### `tests/test_loop_audit.py`
- Removed `@pytest.mark.xfail` from
  `TestHillsideLoopTraversal::test_all_quadrants_grounded`

## Acceptance Criteria Verification

- [x] **Player spindashing from x=3100 visits grounded quadrants {0, 1, 2, 3}**
  — `test_all_quadrants_grounded` passes
- [x] **Player exits the loop region (x > 3744) with positive ground_speed**
  — `test_exits_loop_region` passes

## Test Coverage

### Direct coverage
| Test | Status |
|------|--------|
| `test_loop_audit.py::TestHillsideLoopTraversal::test_all_quadrants_grounded` | PASS |
| `test_loop_audit.py::TestHillsideLoopTraversal::test_exits_loop_region` | PASS |
| `test_hillside_integration.py` (10 tests) | 10/10 PASS |

### Regression suite (all tracked tests)
- **821 passed, 5 xfailed, 0 failures**
- The 5 xfails are pre-existing on other tickets (pipeworks goal,
  skybridge boss, boundary escape × 3)

### Untracked test files (other in-progress tickets)
- `test_mechanic_probes.py`, `test_invariants.py`, `test_qa_framework.py`,
  `test_loop_audit.py::TestSyntheticLoopTraversal` have pre-existing
  failures unrelated to this ticket. The synthetic loop test failures
  (`TestSyntheticLoopTraversal`) involve the general `build_loop()` +
  physics interaction at various radii and are a separate issue from
  the hillside-specific tile data fix.

## Deviations from Plan

1. **Radius 64 instead of 128**: The visual loop spans ~256 pixels
   (r≈128), but r=128 produces a bottom arc so flat that the physics
   engine treats it as near-flat ground. Radius 64 gives curvature
   tight enough that the sensor system follows the player through all
   quadrants. The collision loop is smaller than the visual loop.

2. **Approach gap**: A ~80px gap (tx=214-218) exists between the
   original hillside approach ramp and the synthetic loop entry.
   The player goes briefly airborne crossing this gap but lands on
   the loop wall tiles and completes the traversal.

3. **simulation.py additions**: `create_sim_from_lookup()` and
   `sim_step()` were not planned but were needed by the test harness
   (`test_loop_audit.py`) to run headless loop traversal simulations.

## Open Concerns

1. **Visual-collision mismatch**: The collision loop (r=64) is smaller
   than the visual loop (r≈128). The player traverses a tighter circle
   than what the sprites show. This is acceptable for gameplay (the loop
   works) but means the visual and collision loops are not co-located.
   A future ticket could adjust the visual sprites or find a physics
   solution that works at r=128.

2. **Approach gap**: The ~80px airborne gap before the loop entry is
   functional but not ideal. In Sonic 2, the player transitions smoothly
   from the approach ramp into the loop without leaving the ground. This
   could be improved by extending the synthetic ramp leftward to connect
   with the original hillside terrain.

3. **Synthetic loop test failures**: `TestSyntheticLoopTraversal` (which
   tests `build_loop()` at radii 32-96 in isolation) has pre-existing
   failures where the player loses ground contact at the Q1→Q2 transition.
   These failures indicate a broader physics issue with loop traversal
   that the hillside fix works around (because the hillside player enters
   with high spindash speed). This is out of scope for this bug ticket
   but worth tracking.
