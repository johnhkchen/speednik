# T-010-14 Structure — CleanRL PPO Fork

## Files Modified

### `pyproject.toml`
Add `train` dependency group:
```toml
[dependency-groups]
dev = ["librosa>=0.11.0", "pytest>=9.0.2"]
train = ["torch>=2.0", "tyro", "wandb", "tensorboard"]
```

No changes to main `dependencies` or `[project.optional-dependencies]`.

---

## Files Created

### `tools/ppo_speednik.py`

Fork of CleanRL's `ppo.py` (~250 lines). Structure:

```
imports (standard library)
imports (third-party: gymnasium, numpy, torch, tyro, tensorboard)
import speednik.env_registration          ← CHANGE 1

@dataclass Args:
    env_id: str = "speednik/Hillside-v0"  ← CHANGE 2
    ... (all other args unchanged)

def make_env(env_id, idx, capture_video, run_name):
    ... (with normalization wrapper stack) ← CHANGE 3

def layer_init(layer, std, bias_const):
    ... (unchanged)

class Agent(nn.Module):
    ... (unchanged — 64-unit MLP actor-critic)

if __name__ == "__main__":
    ... (main training loop — unchanged except model save at end)
```

### Detailed change locations

**Top of file** — after existing imports, before `Args`:
```python
import speednik.env_registration  # noqa: F401  # triggers gym.register()
```

**`Args.env_id`** — single line change:
```python
env_id: str = "speednik/Hillside-v0"
```

**`make_env`** — replace body of `thunk()` inner function:
```python
def thunk():
    if capture_video and idx == 0:
        env = gym.make(env_id, render_mode="rgb_array")
        env = gym.wrappers.RecordVideo(env, f"videos/{run_name}")
    else:
        env = gym.make(env_id)
    env = gym.wrappers.RecordEpisodeStatistics(env)
    env = gym.wrappers.NormalizeObservation(env)
    env = gym.wrappers.TransformObservation(
        env, lambda obs: np.clip(obs, -10, 10),
        observation_space=env.observation_space,
    )
    env = gym.wrappers.NormalizeReward(env, gamma=0.99)
    env = gym.wrappers.TransformReward(env, lambda r: np.clip(r, -10, 10))
    return env
```

**End of main block** — add model save before `envs.close()`:
```python
    # Save model checkpoint
    model_path = f"runs/{run_name}/{args.exp_name}.pt"
    torch.save(agent.state_dict(), model_path)
    print(f"Model saved to {model_path}")
```

---

## Files NOT Modified

- `speednik/env.py` — no changes needed
- `speednik/env_registration.py` — no changes needed
- `tests/*.py` — no test changes; training script is not imported by tests
- `justfile` — training is run via `uv run`, not justfile
- `uv.lock` — will be regenerated by `uv sync --group train`

---

## Module Boundaries

```
tools/ppo_speednik.py
    ├── imports speednik.env_registration (side-effect: registers envs)
    ├── calls gymnasium.make("speednik/Hillside-v0")
    │   └── instantiates speednik.env:SpeednikEnv
    ├── wraps with gymnasium.wrappers.*
    ├── creates gymnasium.vector.SyncVectorEnv
    └── trains with torch (PPO algorithm)
```

The training script is a leaf node — nothing imports it. It reaches into the
speednik package only through the Gymnasium registry (env_registration) and the
standard `gym.make()` interface. No direct imports of `env.py`, `simulation.py`,
or any other speednik module.

---

## Dependency Isolation

```
Base install (uv sync):
    pyxel, numpy, gymnasium, pyyaml

Dev install (uv sync --group dev):
    + librosa, pytest

Train install (uv sync --group train):
    + torch, tyro, wandb, tensorboard
```

The `train` group is independent of `dev`. A user wanting to train needs:
```bash
uv sync --group train
```

Tests run without the train group:
```bash
uv sync --group dev
uv run pytest tests/ -x
```
