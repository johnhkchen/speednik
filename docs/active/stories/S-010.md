---
id: S-010
title: scenario-testing-and-gymnasium-system
type: story
status: open
priority: high
tickets: [T-010-01, T-010-02, T-010-03, T-010-04, T-010-05, T-010-06, T-010-07, T-010-08, T-010-09, T-010-10, T-010-11, T-010-12, T-010-13, T-010-14, T-010-15, T-010-16, T-010-17]
---

## Goal

Build the full scenario testing and reinforcement learning stack described in
`docs/specs/scenario-testing-system.md`. Six layers: headless simulation, agent interface,
Gymnasium wrapper, scenario runner with YAML definitions, metrics/comparison pipeline, and
CleanRL PPO integration. Every layer is Pyxel-free. Every agent — programmed or learned —
conforms to the same `Agent` protocol.

## Background

S-008 built a test harness (`tests/harness.py`) that proves the game core is fully
simulatable without Pyxel. But the harness only covers player+terrain — no rings, springs,
enemies, pipes, liquid zones, or goal detection. Strategies access the `Player` object
directly instead of going through a structured observation space. And there's no path from
the harness to RL training.

This story extends the harness into a production simulation layer that mirrors the full
`main.py:_update_gameplay()` loop, wraps it in a Gymnasium environment, and connects it to
CleanRL for PPO training. The spec (`docs/specs/scenario-testing-system.md`) provides the
complete technical design.

## Architecture

```
┌──────────────────────────────────────────────────────────┐
│  6. CleanRL Entry Point (tools/ppo_speednik.py)          │
├──────────────────────────────────────────────────────────┤
│  5. Gymnasium Wrapper (speednik/env.py)                  │
├──────────────────────────────────────────────────────────┤
│  4. Scenario Runner (speednik/scenarios/runner.py)       │
├──────────────────────────────────────────────────────────┤
│  3. Agent Interface (speednik/agents/base.py)            │
├──────────────────────────────────────────────────────────┤
│  2. Headless Simulation (speednik/simulation.py)         │
├──────────────────────────────────────────────────────────┤
│  1. Game Core (existing modules)                         │
└──────────────────────────────────────────────────────────┘
```

## DAG

The critical path is long and measured. At most 2 tickets are concurrent at any point.

```
Gate: [T-009-03, T-009-04, T-009-05]

Step 1: Simulation Module
T-010-01  (SimState + create_sim)
   └──→ T-010-02  (sim_step + event system)

Step 2: Agent Interface (forks from sim_step)
         ├──→ T-010-03  (simulation parity tests)         ┐ 2 concurrent
         └──→ T-010-04  (Agent protocol + obs extraction)  ┘
                └──→ T-010-05  (programmed agents)

Step 3: Gymnasium Wrapper (merges sim tests + agents)
         T-010-03 + T-010-05
                └──→ T-010-06  (SpeednikEnv reset/step/action)
                       ├──→ T-010-07  (reward + obs space)            ┐ 2 concurrent
                       └──→ T-010-09  (scenario YAML format + loader) ┘

Step 3b + Step 4: Gym Registration + Scenario Runner
                         T-010-07 ──→ T-010-08  (env registration + check_env)
                         T-010-09 ──→ T-010-10  (run_scenario + conditions)

Step 4b: Scenario CLI (merges gym + runner)
                               T-010-08 + T-010-10
                                      └──→ T-010-11  (scenario CLI entry point)

Step 5: Metrics + Comparison
                                             └──→ T-010-12  (trajectory + metrics)
                                                    └──→ T-010-13  (baseline comparison)

Step 6 + Step 7: CleanRL + Raycasts (final fork)
                                                          ├──→ T-010-14  (CleanRL fork)    ┐ 2 concurrent
                                                          └──→ T-010-16  (terrain raycast) ┘
                                                               T-010-14 ──→ T-010-15  (PPOAgent + eval)
                                                               T-010-16 ──→ T-010-17  (full 26-dim obs)
```

T-010-15 and T-010-17 are the terminal nodes. The full critical path is 12 tickets deep
(01→02→04→05→06→07→08→11→12→13→14→15 or ...→13→16→17).
