---
id: S-007
title: make-loop-traversable
type: story
status: open
priority: critical
tickets: [T-007-01, T-007-02, T-007-03, T-007-04]
---

## Goal

Make the hillside loop traversable by generating entry/exit transition ramps and adding a
physics safety net so loop tiles are never treated as walls.

## Background

The hillside stage has a 360° loop (circle at cx=3600, cy=508, r=128 in the SVG) that the
player cannot enter. The loop is defined as a bare circle sitting on flat ground with no
geometric transition between the ground surface and the ascending arc. This causes a cascade
of failures:

1. **No ramps → no angle transition.** The player runs on flat ground (angle 0°, quadrant 0).
   Floor sensors cast downward and keep finding flat tiles. When the player reaches the loop's
   ascending left arc, the floor sensors still point down and hit the ground below, never
   picking up the loop surface. The player's angle never changes from 0°.

2. **Angle stuck at 0 → quadrant stays 0.** The Sonic-style physics engine transitions the
   player into quadrant 1 (right-wall mode) at angle 33, which redirects floor sensors
   rightward to follow the loop wall. Without the angle transition, this never fires.

3. **Wall sensors detect loop tiles as walls.** In quadrant 0, wall sensors cast left/right.
   They find the loop's ascending arc tiles. The angle gate (`WALL_ANGLE_THRESHOLD = 48`)
   filters out tiles with angles ≤48 (gentle slopes), but tiles at angles 49–87°
   are treated as genuine walls. The wall push-back zeroes the player's velocity and stops
   them dead — exactly what the screenshot shows.

In Sonic 2, loops always include entry/exit ramps that smoothly transition the ground angle
from 0° up to the loop's tangent angle. As the player's ground angle increases past 32,
they enter quadrant 1 and the sensor geometry rotates to follow the loop surface rather than
fight it.

## Fix Strategy

Two complementary changes:

**Transition ramps (T-007-01, T-007-03):** Both level pipelines (svg2stage and profile2stage)
generate quarter-circle transition arcs at loop entry and exit. The arcs smoothly connect
flat ground (angle 0°) to the loop circle's tangent at the bottom-left (entry) and
bottom-right (exit). The ramp tiles have gradually increasing angles that guide the player
through the quadrant transition.

**Physics safety net (T-007-02):** Propagate tile type to the runtime `Tile` dataclass. In
`find_wall_push`, exempt loop-type tiles from wall push-back. This prevents edge cases where
ramp-to-loop seams or high-speed entry could still trigger wall blocking.

## DAG

```
T-007-01  (svg2stage ramp generation — generates hillside data)
   └──→ T-007-04  (regenerate hillside + verify traversal)

T-007-02  (physics safety net — independent)
   └──→ T-007-04

T-007-03  (profile2stage ramp generation — independent, parity)
```

T-007-01, T-007-02, and T-007-03 are independent and can run in parallel.
T-007-04 depends on T-007-01 and T-007-02 (needs both ramps and physics fix to verify).
