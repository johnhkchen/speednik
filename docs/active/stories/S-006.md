---
id: S-006
title: llm-native-level-design-pipeline
type: story
status: open
priority: high
tickets: [T-006-01, T-006-02, T-006-03, T-006-04, T-006-05]
---

## Goal

Replace SVG as the primary LLM authoring format with a cursor-based track JSON format
(`profile2stage.py`) that eliminates coordinate arithmetic, guarantees terrain connectivity,
and validates geometry before rasterization. Also fix an immediate rasterization bug in the
SVG loop pipeline that produces 1px collision gaps on steep arc sections.

## Background

The SVG → tile pipeline is hostile to LLM authoring for three reasons:
1. Absolute pixel coordinates require running arithmetic that LLMs get silently wrong
2. The rasterizer's `round()` height calculation produces 1px gaps at tile boundaries on steep
   arcs (the loop sides), which the physics engine handles at runtime but the validator flags
3. Polygon fill logic cannot distinguish loop interiors from solid terrain, requiring careful
   shape ordering that is not LLM-reliable

The cursor-based format eliminates problem 1 by construction. The rasterizer fix eliminates
problem 2. Problem 3 disappears in the new format because loops are first-class segment types
with guaranteed-hollow interiors.

## Three-Layer Model

The new format has three independent layers:

**Layer 1 — Track (sequential, cursor-based ground segments):**
Defines ground geometry as an ordered sequence of named segment types. The synthesizer
maintains a cursor (`x`, `y`, `slope`) and advances it as each segment is consumed.
Connectivity is guaranteed — no gaps or overlaps can occur by construction.

**Layer 2 — Overlays (segment-relative, non-cursor features):**
Platforms, springs, and rails positioned relative to a named track segment anchor.
Overlays do not advance the cursor. One-sided platforms get `TOP_ONLY` solidity.

**Layer 3 — Entities (segment-relative, parameterized):**
Enemies, rings, checkpoints, and the player start positioned relative to segment anchors.
`ring_line` is a parameterized shorthand: one entry produces N ring entities with spacing.

## Track Vocabulary (MVP)

- `flat` — horizontal ground, parameterized by `len`
- `ramp` — linear slope, parameterized by `len` and `rise` (positive = descend, negative = ascend)
- `gap` — empty pit, parameterized by `len`
- `loop` — full 360° loop, parameterized by `radius`; tangents auto-matched to adjacent segments
- `wave` — sinusoidal terrain, parameterized by `len`, `amplitude`, `period`; warns+clamps if wave
  would push below level floor
- `halfpipe` — U-shaped depression, parameterized by `len` and `depth`

## Unified Tangent Matching

The synthesizer always inserts an implicit transition arc between any two segments whose endpoint
slopes differ. The LLM writes `flat → loop → flat` and the synthesizer handles entry/exit
continuity. The `curve` named segment type still exists for intentional curved hills, but
it is never required as structural glue.

## DAG

```
T-006-01  (rasterizer fix — standalone, no deps)

T-006-02  (profile2stage core)
   ├──→ T-006-03  (loop segment — also draws on T-006-01 arc math)
   ├──→ T-006-04  (wave + halfpipe segments)
   └──→ T-006-05  (overlays + entities + pre-rasterization validation)
```

T-006-01 and T-006-02 are independent and can run in parallel.
T-006-03, T-006-04, T-006-05 all unblock after T-006-02 and can run in parallel among themselves.
T-006-03 additionally depends on T-006-01 because it reuses the analytical arc-intersection math.
